import React, { useState, useEffect } from 'react';
import { 
  Plus, Wallet, TrendingUp, TrendingDown, Calendar as CalendarIcon, 
  Edit2, Trash2, Save, X, PieChart, BarChart3, ChevronLeft, ChevronRight, 
  Layers, BarChart2, AlertTriangle, CalendarCheck, Activity, Lock, 
  CheckCircle2, PiggyBank, Minus, LogOut, User, Users, LockKeyhole,
  Menu, Target, Home, KeyRound, UserPlus, Smile, Download, Moon, Sun
} from 'lucide-react';

// --- COLORES Y TEMAS GLOBALES ---
const THEME = {
  primary: 'bg-[#008069]', 
  primaryDark: 'bg-[#005c4b]',
  secondary: 'bg-[#25D366]', 
  bg: 'bg-[#efeae2]', 
  white: 'bg-white',
  textPrimary: 'text-[#111b21]',
  textSecondary: 'text-[#54656f]',
  danger: 'text-red-500',
  success: 'text-[#008069]'
};

// --- HELPERS ---
const getLocalDateStr = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
};

const formatCurrency = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 0 }).format(amount);

// --- COMPONENTES VISUALES ---

const BarChartComponent = ({ title, data, maxVal, isDark }) => (
    <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} p-4 rounded-2xl shadow-sm border h-full flex flex-col transition-colors`}>
        <h3 className={`font-bold ${isDark ? 'text-slate-300' : 'text-[#54656f]'} mb-4 flex items-center gap-2 text-sm uppercase tracking-wider`}>
          <BarChart2 className="w-4 h-4" /> {title}
        </h3>
        <div className="flex-1 flex items-end justify-between gap-2 h-40 w-full">
            {data.map((item, i) => (
                <div key={i} className="flex flex-col items-center justify-end h-full w-full group relative">
                    <div className="flex gap-0.5 sm:gap-1 items-end h-full w-full justify-center">
                        <div 
                            className="w-1.5 sm:w-2 bg-[#008069] rounded-t-sm transition-all duration-500 opacity-80"
                            style={{ height: `${maxVal > 0 ? (item.income / maxVal) * 100 : 0}%` }}
                        ></div>
                        <div 
                            className="w-1.5 sm:w-2 bg-red-400 rounded-t-sm transition-all duration-500 opacity-80"
                            style={{ height: `${maxVal > 0 ? (item.expense / maxVal) * 100 : 0}%` }}
                        ></div>
                    </div>
                    <span className={`text-[9px] ${isDark ? 'text-slate-500' : 'text-slate-400'} mt-1 font-medium truncate w-full text-center`}>
                        {item.label.charAt(0)}
                    </span>
                </div>
            ))}
        </div>
    </div>
);

// --- WIDGETS FLOTANTES ---

const FinancialHealthWidget = ({ transactions, isVisible, onClose, currentYear, isDark }) => {
    const [isMinimized, setIsMinimized] = useState(false);
    if (!isVisible) return null;

    const now = new Date();
    const currentMonth = now.getMonth();
    
    let monthIncome = 0;
    let monthExpense = 0;
    let debtReserve = 0;
    const debtCategories = ['Deuda', 'Préstamos', 'Tarjetas de Crédito', 'Deuda Familiar'];

    transactions.forEach(t => {
        const tDate = new Date(t.date + 'T00:00:00');
        if (tDate.getFullYear() === currentYear && tDate.getMonth() === currentMonth) {
            if (t.type === 'income') {
                monthIncome += t.amount;
            } else {
                const isDebt = debtCategories.includes(t.category);
                const isFuture = tDate > new Date(now.setHours(0,0,0,0));
                
                if (isDebt && isFuture) {
                    debtReserve += t.amount;
                } else {
                    monthExpense += t.amount;
                }
            }
        }
    });

    const available = monthIncome - monthExpense;
    const net = available - debtReserve;
    const isGood = net >= 0;

    return (
        <div className={`${isDark ? 'bg-slate-800/95 border-slate-700' : 'bg-white/95 border-slate-200'} backdrop-blur-md border shadow-xl rounded-2xl overflow-hidden transition-all duration-300 w-full md:w-72 pointer-events-auto`}>
            <div className={`p-3 flex justify-between items-center bg-gradient-to-r ${isGood ? 'from-[#008069] to-[#00a884]' : 'from-orange-500 to-red-500'}`}>
                <div className="flex items-center gap-2 cursor-pointer w-full" onClick={() => setIsMinimized(!isMinimized)}>
                    <Activity className="w-3 h-3 text-white" />
                    <h4 className="text-white text-xs font-bold whitespace-nowrap">
                        {isMinimized ? formatCurrency(net) : 'Estado Financiero'}
                    </h4>
                </div>
                <div className="flex items-center gap-1 ml-3">
                    <button onClick={() => setIsMinimized(!isMinimized)} className="text-white/80 hover:text-white p-1"><Minus className="w-3 h-3" /></button>
                    <button onClick={onClose} className="text-white/80 hover:text-white p-1"><X className="w-3 h-3" /></button>
                </div>
            </div>
            {!isMinimized && (
                <div className="p-4 space-y-3">
                    <div className="flex justify-between items-center text-xs">
                        <span className={isDark ? 'text-slate-400' : 'text-slate-500'}>Saldo Operativo</span>
                        <span className={`text-sm font-bold ${isDark ? 'text-slate-200' : 'text-slate-700'}`}>{formatCurrency(available)}</span>
                    </div>
                    {debtReserve > 0 && (
                        <div className="flex justify-between items-center text-orange-600 bg-orange-50 p-2 rounded-lg text-xs">
                            <span className="flex items-center gap-1"><Lock className="w-3 h-3"/> Reserva Deuda</span>
                            <span className="font-bold">- {formatCurrency(debtReserve)}</span>
                        </div>
                    )}
                    <div className={`pt-2 border-t ${isDark ? 'border-slate-700' : 'border-slate-100'} mt-1 text-center ${isGood ? 'text-[#008069]' : 'text-red-500'}`}>
                        <p className="text-[10px] uppercase font-bold tracking-wider">{isGood ? 'Saldo Libre Real' : 'Faltante'}</p>
                        <p className="text-xl font-black">{formatCurrency(Math.abs(net))}</p>
                    </div>
                </div>
            )}
        </div>
    );
};

const BudgetAlertWidget = ({ transactions, budgets, isVisible, onClose, currentYear, isDark }) => {
    const [isMinimized, setIsMinimized] = useState(false);
    if (!isVisible) return null;
    if (!budgets || budgets.length === 0) return null;

    const currentMonth = new Date().getMonth();
    const currentMonthExpenses = {};
    transactions.forEach(t => {
        const tDate = new Date(t.date + 'T00:00:00');
        if (t.type === 'expense' && tDate.getFullYear() === currentYear && tDate.getMonth() === currentMonth) {
            currentMonthExpenses[t.category] = (currentMonthExpenses[t.category] || 0) + t.amount;
        }
    });

    const alerts = budgets.filter(b => {
        const spent = currentMonthExpenses[b.category] || 0;
        return spent >= (b.limit * 0.8);
    }).map(b => {
        const spent = currentMonthExpenses[b.category] || 0;
        return { ...b, spent, percentage: (spent / b.limit) * 100 };
    });

    if (alerts.length === 0) return null;

    return (
        <div className={`${isDark ? 'bg-slate-800/95 border-slate-700' : 'bg-white/95 border-slate-200'} backdrop-blur-md border shadow-xl rounded-2xl overflow-hidden transition-all duration-300 w-full md:w-72 mt-3 pointer-events-auto`}>
            <div className="p-3 flex justify-between items-center bg-amber-500">
                <div className="flex items-center gap-2 cursor-pointer w-full" onClick={() => setIsMinimized(!isMinimized)}>
                    <AlertTriangle className="w-3 h-3 text-white" />
                    <h4 className="text-white text-xs font-bold whitespace-nowrap">Alertas Presupuesto</h4>
                </div>
                <div className="flex items-center gap-1 ml-2">
                    <button onClick={() => setIsMinimized(!isMinimized)} className="text-white/80 hover:text-white p-1 rounded-full"><Minus className="w-3 h-3" /></button>
                    <button onClick={onClose} className="text-white/80 hover:text-white p-1 rounded-full"><X className="w-3 h-3" /></button>
                </div>
            </div>
            {!isMinimized && (
                <div className="p-4 space-y-3">
                    {alerts.map((alert, idx) => (
                        <div key={idx} className="text-xs">
                            <div className="flex justify-between mb-1">
                                <span className={`font-bold ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>{alert.category}</span>
                                <span className={`font-bold ${alert.percentage >= 100 ? 'text-red-500' : 'text-amber-600'}`}>
                                    {Math.round(alert.percentage)}%
                                </span>
                            </div>
                            <div className={`w-full h-1.5 rounded-full ${isDark ? 'bg-slate-700' : 'bg-slate-100'}`}>
                                <div className={`h-full rounded-full ${alert.percentage >= 100 ? 'bg-red-500' : 'bg-amber-500'}`} style={{ width: `${Math.min(alert.percentage, 100)}%` }}></div>
                            </div>
                            <p className={`text-[10px] mt-0.5 ${isDark ? 'text-slate-400' : 'text-slate-500'}`}>
                                {formatCurrency(alert.spent)} de {formatCurrency(alert.limit)}
                            </p>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

const TopExpensesWidget = ({ transactions, isVisible, onClose, currentYear, isDark }) => {
    const [isMinimized, setIsMinimized] = useState(false);
    if (!isVisible) return null;

    const currentMonth = new Date().getMonth();
    const expensesByCategory = {};
    let totalExpense = 0;

    transactions.forEach(t => {
        const tDate = new Date(t.date + 'T00:00:00');
        if (t.type === 'expense' && tDate.getFullYear() === currentYear && tDate.getMonth() === currentMonth) {
            expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
            totalExpense += t.amount;
        }
    });

    const sortedCategories = Object.entries(expensesByCategory).sort(([, a], [, b]) => b - a).slice(0, 3);

    return (
        <div className={`${isDark ? 'bg-slate-800/95 border-slate-700' : 'bg-white/95 border-slate-200'} backdrop-blur-md border shadow-xl rounded-2xl overflow-hidden transition-all duration-300 w-full md:w-72 mt-3 pointer-events-auto`}>
            <div className={`p-3 flex justify-between items-center ${isDark ? 'bg-slate-900' : 'bg-slate-700'}`}>
                <div className="flex items-center gap-2 cursor-pointer w-full" onClick={() => setIsMinimized(!isMinimized)}>
                    <TrendingDown className="w-3 h-3 text-white" />
                    <h4 className="text-white text-xs font-bold whitespace-nowrap">Top Gastos (Mes)</h4>
                </div>
                <div className="flex items-center gap-1 ml-2">
                    <button onClick={() => setIsMinimized(!isMinimized)} className="text-white/80 hover:text-white p-1 rounded-full"><Minus className="w-3 h-3" /></button>
                    <button onClick={onClose} className="text-white/80 hover:text-white p-1 rounded-full"><X className="w-3 h-3" /></button>
                </div>
            </div>
            {!isMinimized && (
                <div className="p-4">
                    {sortedCategories.length > 0 ? (
                        <div className="space-y-3">
                            {sortedCategories.map(([cat, amount], i) => (
                                <div key={cat} className="flex items-center justify-between text-xs">
                                    <div className="flex items-center gap-2">
                                        <span className="font-bold text-slate-400 w-4">#{i+1}</span>
                                        <span className={`font-medium ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>{cat}</span>
                                    </div>
                                    <div className="text-right">
                                        <div className={`font-bold ${isDark ? 'text-slate-200' : 'text-slate-800'}`}>{formatCurrency(amount)}</div>
                                        <div className="text-[9px] text-slate-400">{Math.round((amount / totalExpense) * 100)}%</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <p className="text-xs text-slate-400 text-center py-2">Sin gastos registrados.</p>
                    )}
                </div>
            )}
        </div>
    );
};

const SavingsWidget = ({ transactions, isVisible, onClose, currentYear, isDark }) => {
    const [isMinimized, setIsMinimized] = useState(false);
    const [goal, setGoal] = useState(() => localStorage.getItem('savingsGoal') || 10000);
    const [isEditing, setIsEditing] = useState(false);
    const [tempGoal, setTempGoal] = useState(goal);

    if (!isVisible) return null;

    const saveGoal = () => {
        setGoal(tempGoal);
        localStorage.setItem('savingsGoal', tempGoal);
        setIsEditing(false);
    };

    let totalIncome = 0;
    let totalExpense = 0;

    transactions.forEach(t => {
        const tDate = new Date(t.date + 'T00:00:00');
        if (tDate.getFullYear() === currentYear) {
            if (t.type === 'income') totalIncome += t.amount;
            else totalExpense += t.amount;
        }
    });

    const currentSavings = totalIncome - totalExpense;
    const progress = Math.min((currentSavings / goal) * 100, 100);

    return (
        <div className={`${isDark ? 'bg-slate-800/95 border-slate-700' : 'bg-white/95 border-slate-200'} backdrop-blur-md border shadow-xl rounded-2xl overflow-hidden transition-all duration-300 w-full md:w-72 mt-3 pointer-events-auto`}>
            <div className="p-3 flex justify-between items-center bg-indigo-600">
                <div className="flex items-center gap-2 cursor-pointer w-full" onClick={() => setIsMinimized(!isMinimized)}>
                    <Target className="w-3 h-3 text-white" />
                    <h4 className="text-white text-xs font-bold whitespace-nowrap">Meta Ahorro {currentYear}</h4>
                </div>
                <div className="flex items-center gap-1 ml-2">
                    <button onClick={() => setIsMinimized(!isMinimized)} className="text-white/80 hover:text-white p-1"><Minus className="w-3 h-3" /></button>
                    <button onClick={onClose} className="text-white/80 hover:text-white p-1"><X className="w-3 h-3" /></button>
                </div>
            </div>
            {!isMinimized && (
                <div className="p-4">
                    <div className="flex justify-between items-end mb-2">
                        <div>
                            <p className="text-xs text-slate-500">Acumulado</p>
                            <p className={`text-lg font-bold ${currentSavings >= 0 ? 'text-indigo-500' : 'text-red-500'}`}>{formatCurrency(currentSavings)}</p>
                        </div>
                        <div className="text-right">
                            <p className="text-[10px] text-slate-400">Meta</p>
                            {isEditing ? (
                                <div className="flex items-center gap-1">
                                    <input type="number" className="w-16 text-xs border rounded px-1 outline-none text-black" value={tempGoal} onChange={(e) => setTempGoal(e.target.value)}/>
                                    <button onClick={saveGoal} className="text-green-500"><CheckCircle2 className="w-4 h-4"/></button>
                                </div>
                            ) : (
                                <p className={`text-xs font-semibold ${isDark ? 'text-slate-300' : 'text-slate-600'} cursor-pointer flex items-center gap-1 justify-end`} onClick={() => setIsEditing(true)}>
                                    {formatCurrency(goal)} <Edit2 className="w-3 h-3 opacity-50"/>
                                </p>
                            )}
                        </div>
                    </div>
                    <div className={`w-full ${isDark ? 'bg-slate-700' : 'bg-slate-100'} h-2 rounded-full overflow-hidden mb-1`}>
                        <div className="bg-indigo-500 h-full rounded-full transition-all duration-1000" style={{ width: `${Math.max(0, progress)}%` }}></div>
                    </div>
                    <p className="text-[10px] text-center text-slate-400">{Math.round(progress)}% logrado</p>
                </div>
            )}
        </div>
    );
};

// --- VISTAS ---

// 1. Calendario
const CalendarView = ({ transactions, selectedYear, onDateClick, isDark }) => {
    const [date, setDate] = useState(new Date(selectedYear, new Date().getMonth(), 1));

    useEffect(() => {
        if (date.getFullYear() !== selectedYear) setDate(new Date(selectedYear, 0, 1));
    }, [selectedYear]);

    const getDaysInMonth = (d) => {
        const year = d.getFullYear();
        const month = d.getMonth();
        const days = new Date(year, month + 1, 0).getDate();
        const firstDay = new Date(year, month, 1).getDay(); 
        return { days, firstDay };
    };

    const { days, firstDay } = getDaysInMonth(date);
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

    const changeMonth = (offset) => {
        const newDate = new Date(date);
        newDate.setMonth(newDate.getMonth() + offset);
        setDate(newDate);
    };

    const getDayData = (day) => {
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const dateStr = `${date.getFullYear()}-${month}-${String(day).padStart(2, '0')}`;
        const dayTransactions = transactions.filter(t => t.date === dateStr);
        const income = dayTransactions.filter(t => t.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
        const expense = dayTransactions.filter(t => t.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);
        return { income, expense };
    };

    return (
        <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} rounded-2xl shadow-sm border overflow-hidden animate-fade-in mb-24 transition-colors`}>
            <div className={`p-4 ${isDark ? 'bg-slate-900 border-slate-700' : 'bg-slate-50 border-slate-200'} flex justify-between items-center border-b`}>
                <button onClick={() => changeMonth(-1)} className="p-2 hover:opacity-70 rounded-full text-slate-500"><ChevronLeft className="w-5 h-5"/></button>
                <div className="flex items-center gap-2">
                    <span className={`font-bold ${isDark ? 'text-slate-200' : 'text-slate-700'}`}>{monthNames[date.getMonth()]} {date.getFullYear()}</span>
                    <button onClick={() => setDate(new Date())} className="text-[#008069] bg-[#d9fdd3] p-1 rounded-md text-xs font-bold px-2">Hoy</button>
                </div>
                <button onClick={() => changeMonth(1)} className="p-2 hover:opacity-70 rounded-full text-slate-500"><ChevronRight className="w-5 h-5"/></button>
            </div>
            <div className="p-3">
                <div className="grid grid-cols-7 mb-2 text-center text-xs font-bold text-slate-400">
                    {['D','L','M','M','J','V','S'].map((d, i) => <div key={i} className="py-1">{d}</div>)}
                </div>
                <div className="grid grid-cols-7 gap-1">
                    {[...Array(firstDay)].map((_, i) => <div key={`empty-${i}`} className="aspect-square"></div>)}
                    {[...Array(days)].map((_, i) => {
                        const day = i + 1;
                        const { income, expense } = getDayData(day);
                        const balance = income - expense;
                        const isToday = new Date().toDateString() === new Date(date.getFullYear(), date.getMonth(), day).toDateString();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const dateStr = `${date.getFullYear()}-${month}-${String(day).padStart(2, '0')}`;
                        const hasData = income > 0 || expense > 0;

                        return (
                            <button key={day} onClick={() => onDateClick(dateStr)} className={`relative min-h-[70px] border rounded-lg p-1 flex flex-col justify-between transition hover:border-[#008069] ${isToday ? 'bg-[#e7f5f2] border-[#008069]' : isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                                <span className={`text-[10px] font-bold ${isToday ? 'text-[#008069]' : 'text-slate-400'}`}>{day}</span>
                                {hasData && (
                                    <div className="w-full text-center">
                                        <div className="flex justify-center gap-0.5 mb-0.5">
                                            {income > 0 && <div className="w-1.5 h-1.5 rounded-full bg-[#008069]"></div>}
                                            {expense > 0 && <div className="w-1.5 h-1.5 rounded-full bg-red-500"></div>}
                                        </div>
                                        <span className={`block text-[9px] font-bold leading-tight ${balance >= 0 ? 'text-[#008069]' : 'text-red-500'}`}>{formatCurrency(Math.abs(balance))}</span>
                                    </div>
                                )}
                            </button>
                        );
                    })}
                </div>
            </div>
        </div>
    );
};

// 2. Historial
const HistoryView = ({ transactions, onEdit, onDelete, isDark }) => {
    const grouped = {};
    const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
    sorted.forEach(t => { if (!grouped[t.date]) grouped[t.date] = []; grouped[t.date].push(t); });

    return (
        <div className="space-y-4 pb-24 animate-fade-in">
            {Object.keys(grouped).length === 0 && <div className="text-center py-10 text-slate-400 opacity-50"><Layers className="w-12 h-12 mx-auto mb-2" /><p>Sin movimientos</p></div>}
            {Object.entries(grouped).map(([date, items]) => (
                <div key={date}>
                    <div className="flex justify-center mb-2"><span className="bg-[#e1f3fb] text-slate-600 text-[10px] font-bold px-3 py-1 rounded-full shadow-sm">{new Date(date + 'T00:00:00').toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' })}</span></div>
                    <div className="space-y-1.5">
                        {items.map(t => (
                            <div key={t.id} onClick={() => onEdit(t)} className={`relative flex flex-col p-3 rounded-lg shadow-sm border border-transparent hover:border-slate-200 transition cursor-pointer ${t.type === 'income' ? (isDark ? 'bg-slate-800 text-slate-200 ml-0 mr-8 rounded-tl-none' : 'bg-white ml-0 mr-8 rounded-tl-none') : 'bg-[#d9fdd3] ml-8 mr-0 rounded-tr-none'}`}>
                                <div className="flex justify-between items-start">
                                    <div className="flex items-center gap-2 mb-1">
                                        <div className="w-5 h-5 rounded-full flex items-center justify-center text-[9px] font-bold text-white shadow-sm" style={{ backgroundColor: t.userColor || '#ccc' }}>{t.userName ? t.userName.charAt(0).toUpperCase() : '?'}</div>
                                        <span className={`text-xs font-bold ${t.type === 'income' ? 'text-[#008069]' : 'text-slate-700'}`}>{t.category}</span>
                                    </div>
                                    <span className={`text-sm font-bold ${t.type === 'income' ? (isDark ? 'text-slate-300' : 'text-slate-600') : 'text-slate-800'}`}>{t.type === 'income' ? '+ ' : '- '}{formatCurrency(t.amount)}</span>
                                </div>
                                <div className="flex justify-between items-end mt-1">
                                    <p className="text-[10px] text-slate-500 line-clamp-1">{t.userName} • {t.type === 'expense' ? 'Gasto' : 'Ingreso'}</p>
                                    <div className="flex gap-2"><button onClick={(e) => { e.stopPropagation(); onDelete(t.id); }} className="text-slate-300 hover:text-red-400 transition"><Trash2 className="w-3 h-3" /></button></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            ))}
        </div>
    );
};

// 3. Miembros
const MembersView = ({ family, updateFamilyMembers, isDark }) => {
    const [newMemberName, setNewMemberName] = useState('');
    const colors = ['#EF4444', '#F97316', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#8B5CF6', '#EC4899'];
    const addMember = (e) => {
        e.preventDefault();
        if (!newMemberName.trim()) return;
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        const newMember = { id: Date.now(), name: newMemberName.trim(), color: randomColor };
        updateFamilyMembers([...(family.members || []), newMember]);
        setNewMemberName('');
    };
    const removeMember = (id) => { if(window.confirm('¿Eliminar?')) updateFamilyMembers(family.members.filter(m => m.id !== id)); };

    return (
        <div className="space-y-6 pb-24 animate-fade-in">
            <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} p-6 rounded-2xl shadow-sm border`}>
                <h3 className={`font-bold ${isDark ? 'text-slate-200' : 'text-slate-700'} mb-4 flex items-center gap-2`}><Users className="w-5 h-5 text-[#008069]" /> Integrantes</h3>
                <form onSubmit={addMember} className="flex gap-2 mb-6">
                    <input type="text" value={newMemberName} onChange={(e) => setNewMemberName(e.target.value)} placeholder="Nombre..." className={`flex-1 ${isDark ? 'bg-slate-700 text-slate-200 border-slate-600' : 'bg-slate-50 text-slate-700 border-slate-200'} border rounded-xl px-4 py-2 outline-none focus:border-[#008069] text-sm`} />
                    <button type="submit" className="bg-[#008069] text-white p-2 rounded-xl hover:bg-[#005c4b]"><UserPlus className="w-5 h-5" /></button>
                </form>
                <div className="space-y-3">
                    {family.members && family.members.length > 0 ? (
                        family.members.map(member => (
                            <div key={member.id} className={`flex items-center justify-between p-3 ${isDark ? 'bg-slate-700/50 border-slate-700' : 'bg-slate-50 border-slate-100'} rounded-xl border`}>
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs shadow-sm" style={{ backgroundColor: member.color }}>{member.name.charAt(0).toUpperCase()}</div>
                                    <span className={`font-medium ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>{member.name}</span>
                                </div>
                                <button onClick={() => removeMember(member.id)} className="text-slate-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button>
                            </div>
                        ))
                    ) : <p className="text-slate-500 text-center text-sm">Sin miembros extra.</p>}
                </div>
            </div>
        </div>
    );
};

// 4. Presupuestos
const BudgetsView = ({ transactions, currentYear, family, isDark }) => {
    const [budgets, setBudgets] = useState(() => {
        const saved = localStorage.getItem(`budgets_${family.id}`);
        return saved ? JSON.parse(saved) : [];
    });
    const [newBudget, setNewBudget] = useState({ category: '', limit: '' });

    useEffect(() => {
        localStorage.setItem(`budgets_${family.id}`, JSON.stringify(budgets));
    }, [budgets, family.id]);

    const categories = ['Comida', 'Transporte', 'Vivienda', 'Escuela', 'Despensa', 'Tienda', 'Comida a domicilio', 'Servicios', 'Deuda', 'Gastos Hormiga', 'Otros'];

    const currentMonth = new Date().getMonth();
    
    const expensesByCategory = {};
    transactions.forEach(t => {
        const tDate = new Date(t.date + 'T00:00:00');
        if (t.type === 'expense' && tDate.getFullYear() === currentYear && tDate.getMonth() === currentMonth) {
            expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
        }
    });

    const handleAddBudget = (e) => {
        e.preventDefault();
        if (!newBudget.category || !newBudget.limit) return;
        const filtered = budgets.filter(b => b.category !== newBudget.category);
        setBudgets([...filtered, { ...newBudget, limit: parseFloat(newBudget.limit) }]);
        setNewBudget({ category: '', limit: '' });
    };

    const removeBudget = (cat) => {
        if(window.confirm('¿Eliminar presupuesto?')) {
            setBudgets(budgets.filter(b => b.category !== cat));
        }
    };

    return (
        <div className="space-y-6 pb-24 animate-fade-in">
            <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} p-6 rounded-2xl shadow-sm border transition-colors`}>
                <h3 className={`font-bold ${isDark ? 'text-slate-200' : 'text-slate-700'} mb-4 flex items-center gap-2`}><PiggyBank className="w-5 h-5 text-[#008069]" /> Presupuestos Mensuales</h3>
                
                <form onSubmit={handleAddBudget} className="flex gap-2 mb-6 flex-wrap">
                    <select 
                        value={newBudget.category} 
                        onChange={(e) => setNewBudget({...newBudget, category: e.target.value})}
                        className={`flex-1 ${isDark ? 'bg-slate-700 text-slate-200 border-slate-600' : 'bg-slate-50 text-slate-700 border-slate-200'} border rounded-xl px-4 py-2 outline-none focus:border-[#008069] text-sm`}
                    >
                        <option value="">Categoría</option>
                        {categories.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                    <input 
                        type="number" 
                        value={newBudget.limit} 
                        onChange={(e) => setNewBudget({...newBudget, limit: e.target.value})} 
                        placeholder="Límite $"
                        className={`flex-1 ${isDark ? 'bg-slate-700 text-slate-200 border-slate-600 placeholder-slate-400' : 'bg-slate-50 text-slate-700 border-slate-200'} border rounded-xl px-4 py-2 outline-none focus:border-[#008069] text-sm`}
                    />
                    <button type="submit" className="bg-[#008069] text-white p-2 rounded-xl hover:bg-[#005c4b]"><Plus className="w-5 h-5" /></button>
                </form>

                <div className="space-y-4">
                    {budgets.length > 0 ? (
                        budgets.map(b => {
                            const spent = expensesByCategory[b.category] || 0;
                            const percentage = Math.min((spent / b.limit) * 100, 100);
                            const remaining = b.limit - spent;
                            let color = 'bg-[#008069]';
                            if (percentage > 75) color = 'bg-amber-500';
                            if (percentage >= 100) color = 'bg-red-500';

                            return (
                                <div key={b.category} className={`p-4 ${isDark ? 'bg-slate-700/50' : 'bg-slate-50'} rounded-xl`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="flex items-center gap-2">
                                            <span className={`font-bold ${isDark ? 'text-slate-200' : 'text-slate-700'}`}>{b.category}</span>
                                            {percentage >= 100 && <AlertTriangle className="w-4 h-4 text-red-500" />}
                                        </div>
                                        <button onClick={() => removeBudget(b.category)} className="text-slate-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button>
                                    </div>
                                    <div className={`w-full ${isDark ? 'bg-slate-600' : 'bg-slate-200'} h-2.5 rounded-full overflow-hidden mb-2`}>
                                        <div className={`h-full rounded-full transition-all duration-1000 ${color}`} style={{ width: `${percentage}%` }}></div>
                                    </div>
                                    <div className="flex justify-between text-xs">
                                        <span className={`${isDark ? 'text-slate-400' : 'text-slate-500'}`}>Gastado: {formatCurrency(spent)}</span>
                                        <span className={`font-bold ${remaining < 0 ? 'text-red-500' : isDark ? 'text-slate-300' : 'text-slate-700'}`}>
                                            {remaining < 0 ? `Excedido: ${formatCurrency(Math.abs(remaining))}` : `Quedan: ${formatCurrency(remaining)}`}
                                        </span>
                                    </div>
                                </div>
                            )
                        })
                    ) : (
                        <p className="text-center text-slate-400 text-sm py-4">No has definido presupuestos.</p>
                    )}
                </div>
            </div>
        </div>
    );
};

const DashboardView = ({ transactions, isDark }) => {
    const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
    const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
    const monthlyData = Array(12).fill(0).map((_, i) => {
        const mTrans = transactions.filter(t => new Date(t.date+'T00:00:00').getMonth() === i);
        return {
            label: new Date(2000, i, 1).toLocaleString('es-MX', { month: 'short' }),
            income: mTrans.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0),
            expense: mTrans.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0)
        };
    });
    const maxVal = Math.max(...monthlyData.map(d => Math.max(d.income, d.expense))) || 100;

    return (
        <div className="space-y-4 animate-fade-in pb-24">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} p-4 rounded-2xl shadow-sm border flex flex-col justify-between h-28 relative overflow-hidden`}>
                    <div className="absolute top-0 right-0 p-3 opacity-10"><Wallet className="w-12 h-12 text-[#008069]" /></div>
                    <p className="text-xs font-bold text-slate-400 uppercase">Balance Anual</p>
                    <p className={`text-3xl font-black ${income - expense >= 0 ? (isDark ? 'text-slate-200' : 'text-[#111b21]') : 'text-red-500'}`}>{formatCurrency(income - expense)}</p>
                </div>
                 <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} p-4 rounded-2xl shadow-sm border flex items-center justify-between`}>
                    <div><p className="text-xs text-slate-400 font-bold uppercase">Ingresos</p><p className="text-xl font-bold text-[#008069]">{formatCurrency(income)}</p></div>
                    <div className="bg-[#d9fdd3] p-2 rounded-full"><TrendingUp className="w-5 h-5 text-[#008069]" /></div>
                </div>
                <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} p-4 rounded-2xl shadow-sm border flex items-center justify-between`}>
                    <div><p className="text-xs text-slate-400 font-bold uppercase">Gastos</p><p className="text-xl font-bold text-red-500">{formatCurrency(expense)}</p></div>
                    <div className="bg-red-50 p-2 rounded-full"><TrendingDown className="w-5 h-5 text-red-500" /></div>
                </div>
            </div>
            <div className="h-64">
                <BarChartComponent title={`Flujo de Efectivo Anual`} data={monthlyData} maxVal={maxVal} isDark={isDark} />
            </div>
        </div>
    );
};

// --- AUTH SCREEN ---
const AuthScreen = ({ onLogin }) => {
    const [mode, setMode] = useState('login'); 
    const [formData, setFormData] = useState({ familyName: '', familyKey: '', username: '', password: '' });
    const [error, setError] = useState('');

    const handleAuth = (e) => {
        e.preventDefault();
        setError('');
        if (!formData.username.trim() || !formData.password.trim()) { setError('Usuario y contraseña requeridos'); return; }
        if (mode !== 'login' && (!formData.familyName.trim() || !formData.familyKey.trim())) { setError('Datos de familia requeridos'); return; }

        const storedFamilies = JSON.parse(localStorage.getItem('financeFamilies') || '[]');
        const storedUsers = JSON.parse(localStorage.getItem('financeUsers') || '[]');

        if (mode === 'login') {
            const user = storedUsers.find(u => u.username === formData.username && u.password === formData.password);
            if (user) {
                const family = storedFamilies.find(f => f.id === user.familyId);
                if(family) onLogin(user, family);
                else setError('Error de datos: Familia no encontrada');
            } else {
                setError('Credenciales incorrectas');
            }
        } 
        else if (mode === 'create_family') {
            if (storedFamilies.find(f => f.name === formData.familyName)) { setError('Ya existe una familia con este nombre'); return; }
            if (storedUsers.find(u => u.username === formData.username)) { setError('Este nombre de usuario ya está ocupado'); return; }

            const newFamily = { id: Date.now(), name: formData.familyName, key: formData.familyKey, members: [] };
            const newUser = { 
                id: Date.now() + 1, 
                username: formData.username, 
                password: formData.password, 
                familyId: newFamily.id, 
                role: 'admin',
                color: `hsl(${Math.random() * 360}, 70%, 40%)`
            };

            localStorage.setItem('financeFamilies', JSON.stringify([...storedFamilies, newFamily]));
            localStorage.setItem('financeUsers', JSON.stringify([...storedUsers, newUser]));
            onLogin(newUser, newFamily);
        }
        else if (mode === 'join_family') {
            const family = storedFamilies.find(f => f.name === formData.familyName && f.key === formData.familyKey);
            if (!family) { setError('Familia no encontrada o clave incorrecta'); return; }
            if (storedUsers.find(u => u.username === formData.username)) { setError('Este nombre de usuario ya existe'); return; }

            const newUser = { 
                id: Date.now(), 
                username: formData.username, 
                password: formData.password, 
                familyId: family.id, 
                role: 'member',
                color: `hsl(${Math.random() * 360}, 70%, 40%)`
            };

            localStorage.setItem('financeUsers', JSON.stringify([...storedUsers, newUser]));
            onLogin(newUser, family);
        }
    };

    return (
        <div className={`min-h-screen flex items-center justify-center ${THEME.bg} p-4`}>
            <div className="bg-white w-full max-w-md rounded-2xl shadow-xl overflow-hidden">
                <div className={`${THEME.primary} p-8 text-center`}>
                    <div className="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm"><Users className="w-8 h-8 text-white" /></div>
                    <h1 className="text-2xl font-bold text-white mb-1">Control Familiar</h1>
                    <p className="text-white/80 text-sm">Finanzas compartidas y seguras</p>
                </div>
                
                <div className="flex border-b border-gray-100">
                    <button onClick={() => {setMode('login'); setError('');}} className={`flex-1 py-3 text-sm font-bold ${mode === 'login' ? 'text-[#008069] border-b-2 border-[#008069]' : 'text-gray-400'}`}>Entrar</button>
                    <button onClick={() => {setMode('create_family'); setError('');}} className={`flex-1 py-3 text-sm font-bold ${mode === 'create_family' ? 'text-[#008069] border-b-2 border-[#008069]' : 'text-gray-400'}`}>Crear Familia</button>
                    <button onClick={() => {setMode('join_family'); setError('');}} className={`flex-1 py-3 text-sm font-bold ${mode === 'join_family' ? 'text-[#008069] border-b-2 border-[#008069]' : 'text-gray-400'}`}>Unirse</button>
                </div>

                <div className="p-8">
                    <form onSubmit={handleAuth} className="space-y-4">
                        {mode !== 'login' && (
                            <>
                                <div className="p-3 bg-blue-50 rounded-xl border border-blue-100">
                                    <label className="block text-xs font-bold text-blue-800 uppercase mb-1">Datos de Familia</label>
                                    <div className="flex items-center border-b border-blue-200 py-1 mb-2">
                                        <Home className="w-4 h-4 text-blue-400 mr-2" />
                                        <input type="text" value={formData.familyName} onChange={(e) => setFormData({...formData, familyName: e.target.value})} className="w-full outline-none text-blue-900 bg-transparent text-sm" placeholder="Nombre Familia" />
                                    </div>
                                    <div className="flex items-center border-b border-blue-200 py-1">
                                        <KeyRound className="w-4 h-4 text-blue-400 mr-2" />
                                        <input type="password" value={formData.familyKey} onChange={(e) => setFormData({...formData, familyKey: e.target.value})} className="w-full outline-none text-blue-900 bg-transparent text-sm" placeholder="Código Secreto" />
                                    </div>
                                </div>
                            </>
                        )}
                        <div className="p-3 bg-slate-50 rounded-xl border border-slate-100">
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Mis Datos</label>
                            <div className="flex items-center border-b border-slate-200 py-1 mb-2">
                                <User className="w-4 h-4 text-slate-400 mr-2" />
                                <input type="text" value={formData.username} onChange={(e) => setFormData({...formData, username: e.target.value})} className="w-full outline-none text-slate-700 bg-transparent text-sm" placeholder="Mi Usuario" />
                            </div>
                            <div className="flex items-center border-b border-slate-200 py-1">
                                <LockKeyhole className="w-4 h-4 text-slate-400 mr-2" />
                                <input type="password" value={formData.password} onChange={(e) => setFormData({...formData, password: e.target.value})} className="w-full outline-none text-slate-700 bg-transparent text-sm" placeholder="Mi Contraseña" />
                            </div>
                        </div>
                        {error && <p className="text-red-500 text-xs font-medium text-center">{error}</p>}
                        <button type="submit" className={`w-full ${THEME.primary} text-white py-3 rounded-xl font-bold shadow-lg hover:opacity-90 transition transform active:scale-95`}>{mode === 'login' ? 'Iniciar Sesión' : mode === 'create_family' ? 'Crear Todo e Ingresar' : 'Unirme e Ingresar'}</button>
                    </form>
                </div>
            </div>
        </div>
    );
};

// --- APP PRINCIPAL ---
const App = () => {
  const [currentUser, setCurrentUser] = useState(() => {
      const saved = localStorage.getItem('familyApp_currentUser');
      return saved ? JSON.parse(saved) : null;
  });
  const [currentFamily, setCurrentFamily] = useState(() => {
      const saved = localStorage.getItem('familyApp_currentFamily');
      return saved ? JSON.parse(saved) : null;
  });

  const [transactions, setTransactions] = useState(() => {
      if (!currentFamily) return [];
      const allTrans = JSON.parse(localStorage.getItem('financeData') || '[]');
      return allTrans.filter(t => t.familyId === currentFamily.id);
  });

  const [allUsers, setAllUsers] = useState([]);
  useEffect(() => {
      if(currentFamily) {
          const users = JSON.parse(localStorage.getItem('financeUsers') || '[]');
          setAllUsers(users);
      }
  }, [currentFamily]);

  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
  const [view, setView] = useState('dashboard'); 
  const [isFormOpen, setIsFormOpen] = useState(false);
  const [editingId, setEditingId] = useState(null);
  
  // Widget y Dark Mode Config
  const [widgets, setWidgets] = useState(() => {
      const saved = localStorage.getItem('widgetConfig');
      return saved ? JSON.parse(saved) : { health: true, topExpenses: true, savings: true, budgetAlert: true };
  });
  const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem('darkMode') === 'true');

  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [deleteModal, setDeleteModal] = useState({ show: false, id: null });
  const initialFormState = { amount: '', type: 'expense', category: 'Comida', date: getLocalDateStr(new Date()), memberId: '' };
  const [formData, setFormData] = useState(initialFormState);

  // Sync Data
  useEffect(() => {
      if (!currentFamily) return;
      const allTrans = JSON.parse(localStorage.getItem('financeData') || '[]');
      const otherTrans = allTrans.filter(t => t.familyId !== currentFamily.id);
      localStorage.setItem('financeData', JSON.stringify([...otherTrans, ...transactions]));
  }, [transactions, currentFamily]);

  useEffect(() => { 
      if(currentUser) localStorage.setItem('familyApp_currentUser', JSON.stringify(currentUser)); 
      else localStorage.removeItem('familyApp_currentUser');
  }, [currentUser]);

  useEffect(() => { 
      if(currentFamily) localStorage.setItem('familyApp_currentFamily', JSON.stringify(currentFamily)); 
      else localStorage.removeItem('familyApp_currentFamily');
  }, [currentFamily]);

  useEffect(() => { localStorage.setItem('widgetConfig', JSON.stringify(widgets)); }, [widgets]);
  useEffect(() => { localStorage.setItem('darkMode', isDarkMode); }, [isDarkMode]);

  // Actions
  const handleLogin = (user, family) => {
      setCurrentUser(user);
      setCurrentFamily(family);
      const allTrans = JSON.parse(localStorage.getItem('financeData') || '[]');
      setTransactions(allTrans.filter(t => t.familyId === family.id));
      setView('dashboard');
  };
  const handleLogout = () => { setCurrentUser(null); setCurrentFamily(null); };
  const toggleWidget = (key) => setWidgets(prev => ({ ...prev, [key]: !prev[key] }));
  const toggleDarkMode = () => setIsDarkMode(!isDarkMode);

  // Funciones de actualización
  const updateFamilyMembers = (newMembers) => {
      const updatedFamily = { ...currentFamily, members: newMembers };
      setCurrentFamily(updatedFamily);
      const allFamilies = JSON.parse(localStorage.getItem('financeFamilies') || '[]');
      const updatedFamilies = allFamilies.map(f => f.id === currentFamily.id ? updatedFamily : f);
      localStorage.setItem('financeFamilies', JSON.stringify(updatedFamilies));
  };

  const exportData = () => {
      const headers = ["Fecha", "Tipo", "Categoría", "Monto", "Miembro"];
      const rows = transactions.map(t => [
          t.date,
          t.type === 'income' ? 'Ingreso' : 'Gasto',
          t.category,
          t.amount,
          t.userName
      ]);
      const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].map(e => e.join(",")).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `finanzas_${currentFamily.name}_${selectedYear}.csv`);
      document.body.appendChild(link);
      link.click();
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.amount) return; 
    let targetMemberName = currentUser.username;
    let targetMemberColor = currentUser.color;
    if (formData.memberId) {
         const extraMember = currentFamily.members?.find(m => m.id.toString() === formData.memberId);
         if(extraMember) {
             targetMemberName = extraMember.name;
             targetMemberColor = extraMember.color;
         }
    }
    const newTransaction = {
      id: editingId || Date.now(),
      familyId: currentFamily.id,
      ...formData,
      amount: parseFloat(formData.amount),
      userId: currentUser.id,
      userName: targetMemberName,
      userColor: targetMemberColor
    };
    if (editingId) setTransactions(prev => prev.map(t => t.id === editingId ? newTransaction : t));
    else setTransactions(prev => [...prev, newTransaction]);
    closeForm();
  };

  const deleteItem = () => {
      if (deleteModal.id) {
          setTransactions(prev => prev.filter(t => t.id !== deleteModal.id));
          setDeleteModal({ show: false, id: null });
          if (editingId === deleteModal.id) closeForm();
      }
  };

  const openForm = (t = null, date = null) => {
      if (t) { 
          const extraMemberId = currentFamily.members?.find(m => m.name === t.userName)?.id?.toString() || '';
          setFormData({ ...t, memberId: extraMemberId }); 
          setEditingId(t.id); 
      } else { 
          const d = date || getLocalDateStr(new Date());
          const initialType = date ? 'income' : 'expense';
          const initialCategory = initialType === 'income' ? 'Salario' : 'Comida';
          setFormData({ ...initialFormState, date: d, type: initialType, category: initialCategory, memberId: '' }); 
          setEditingId(null);
      }
      setIsFormOpen(true);
  };
  const closeForm = () => { setIsFormOpen(false); setEditingId(null); setFormData(initialFormState); };

  const currentYearData = transactions.filter(t => new Date(t.date + 'T00:00:00').getFullYear() === selectedYear);

  // Recuperar presupuestos
  const familyBudgets = JSON.parse(localStorage.getItem(`budgets_${currentFamily?.id}`) || '[]');

  if (!currentUser || !currentFamily) return <AuthScreen onLogin={handleLogin} />;

  const BgColor = isDarkMode ? 'bg-slate-900' : THEME.bg;
  const TextColor = isDarkMode ? 'text-slate-200' : 'text-slate-800';
  const CardBg = isDarkMode ? 'bg-slate-800' : 'bg-white';
  const BorderColor = isDarkMode ? 'border-slate-700' : 'border-slate-200';

  return (
    <div className={`min-h-screen ${BgColor} ${TextColor} font-sans flex overflow-hidden transition-colors duration-300`}>
        {/* Sidebar */}
        <aside className={`fixed inset-y-0 left-0 z-50 w-72 ${CardBg} border-r ${BorderColor} transform transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:static flex flex-col`}>
            <div className={`h-16 ${isDarkMode ? 'bg-slate-900' : 'bg-[#f0f2f5]'} flex items-center px-4 justify-between border-b ${BorderColor}`}>
                <div className="flex items-center gap-3">
                    <div className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold shadow-sm" style={{ backgroundColor: currentUser.color }}>{currentUser.username.charAt(0).toUpperCase()}</div>
                    <div><p className={`text-sm font-bold ${TextColor}`}>{currentUser.username}</p><p className="text-[10px] opacity-60">En línea</p></div>
                </div>
                <div className="flex gap-1">
                    <button onClick={handleLogout} className="p-2 opacity-60 hover:opacity-100 transition" title="Salir"><LogOut className="w-4 h-4" /></button>
                    <button onClick={() => setIsSidebarOpen(false)} className="p-2 md:hidden"><X className="w-5 h-5"/></button>
                </div>
            </div>
            
            <div className="p-4 flex-1 overflow-y-auto">
                <div className="mb-6">
                    <h3 className="text-xs font-bold text-[#008069] uppercase mb-2 px-2">Menú Principal</h3>
                    <nav className="space-y-1">
                        <button onClick={() => { setView('dashboard'); setIsSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition ${view === 'dashboard' ? 'bg-[#e7f5f2] text-[#008069]' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}><PieChart className="w-4 h-4" /> Resumen</button>
                        <button onClick={() => { setView('calendar'); setIsSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition ${view === 'calendar' ? 'bg-[#e7f5f2] text-[#008069]' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}><CalendarIcon className="w-4 h-4" /> Calendario</button>
                        <button onClick={() => { setView('history'); setIsSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition ${view === 'history' ? 'bg-[#e7f5f2] text-[#008069]' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}><Layers className="w-4 h-4" /> Historial</button>
                        <button onClick={() => { setView('budgets'); setIsSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition ${view === 'budgets' ? 'bg-[#e7f5f2] text-[#008069]' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}><PiggyBank className="w-4 h-4" /> Presupuestos</button>
                        <button onClick={() => { setView('members'); setIsSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition ${view === 'members' ? 'bg-[#e7f5f2] text-[#008069]' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}><Users className="w-4 h-4" /> Miembros Extra</button>
                    </nav>
                </div>
                <div className="mb-6">
                    <h3 className="text-xs font-bold text-[#008069] uppercase mb-2 px-2">Utilidades</h3>
                    <button onClick={exportData} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition hover:bg-slate-100 dark:hover:bg-slate-700 mb-2 ${TextColor}`}><Download className="w-4 h-4" /> Exportar Datos</button>
                    <button onClick={toggleDarkMode} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition hover:bg-slate-100 dark:hover:bg-slate-700 ${TextColor}`}>{isDarkMode ? <Sun className="w-4 h-4" /> : <Moon className="w-4 h-4" />} {isDarkMode ? 'Modo Claro' : 'Modo Oscuro'}</button>
                </div>
                <div className="mb-6">
                    <h3 className="text-xs font-bold text-[#008069] uppercase mb-2 px-2">Widgets</h3>
                    <div className={`${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-100'} rounded-xl p-3 space-y-3 border`}>
                        {[{k:'health',l:'Estado',i:Activity}, {k:'topExpenses',l:'Top Gastos',i:TrendingDown}, {k:'savings',l:'Ahorro',i:Target}, {k:'budgetAlert',l:'Alertas',i:AlertTriangle}].map(w => (
                             <label key={w.k} className="flex items-center justify-between cursor-pointer group">
                                <span className={`text-sm flex items-center gap-2 ${TextColor}`}><w.i className="w-4 h-4 opacity-50" /> {w.l}</span>
                                <div className={`w-9 h-5 flex items-center bg-gray-300 rounded-full p-1 duration-300 ease-in-out ${widgets[w.k] ? 'bg-[#008069]' : ''}`} onClick={() => toggleWidget(w.k)}>
                                    <div className={`bg-white w-3 h-3 rounded-full shadow-md transform duration-300 ease-in-out ${widgets[w.k] ? 'translate-x-4' : ''}`}></div>
                                </div>
                            </label>
                        ))}
                    </div>
                </div>
            </div>
        </aside>

        {isSidebarOpen && <div className="fixed inset-0 bg-black/30 z-40 md:hidden backdrop-blur-sm" onClick={() => setIsSidebarOpen(false)}></div>}

        <div className="flex-1 flex flex-col h-screen relative w-full overflow-hidden">
            <header className={`${THEME.primary} h-16 flex items-center justify-between px-4 shadow-md z-20`}>
                <div className="flex items-center gap-3">
                    <button onClick={() => setIsSidebarOpen(true)} className="md:hidden text-white p-1"><Menu className="w-6 h-6" /></button>
                    <div className="flex flex-col"><h1 className="text-white font-bold text-lg leading-tight">Familia {currentFamily.name}</h1><p className="text-white/70 text-xs">Control de Gastos</p></div>
                </div>
                <div className="flex items-center bg-black/10 rounded-full px-2 py-1">
                    <button onClick={() => setSelectedYear(y => y - 1)} className="text-white/70 hover:text-white"><ChevronLeft className="w-4 h-4" /></button>
                    <span className="px-2 text-sm font-medium text-white">{selectedYear}</span>
                    <button onClick={() => setSelectedYear(y => y + 1)} className="text-white/70 hover:text-white"><ChevronRight className="w-4 h-4" /></button>
                </div>
            </header>

            <main className="flex-1 overflow-y-auto p-4 relative" style={{ backgroundImage: `radial-gradient(${isDarkMode ? '#334155' : '#cbd5e1'} 1px, transparent 1px)`, backgroundSize: '20px 20px' }}>
                <div className="max-w-4xl mx-auto pb-24">
                    {view === 'dashboard' && <DashboardView transactions={currentYearData} isDark={isDarkMode} />}
                    {view === 'calendar' && <CalendarView transactions={currentYearData} selectedYear={selectedYear} onDateClick={(d) => openForm(null, d)} isDark={isDarkMode} />}
                    {view === 'history' && <HistoryView transactions={currentYearData} onEdit={openForm} onDelete={(id) => setDeleteModal({ show: true, id })} isDark={isDarkMode} />}
                    {view === 'members' && <MembersView family={currentFamily} updateFamilyMembers={updateFamilyMembers} isDark={isDarkMode} />}
                    {view === 'budgets' && <BudgetsView transactions={currentYearData} currentYear={selectedYear} family={currentFamily} isDark={isDarkMode} />}
                </div>
            </main>

            <button onClick={() => openForm()} className={`fixed bottom-20 right-4 md:bottom-8 md:right-8 w-14 h-14 ${THEME.primary} hover:bg-[#006e5a] text-white rounded-2xl shadow-lg flex items-center justify-center transition-transform hover:scale-105 active:scale-95 z-40`}>
                <Plus className="w-7 h-7" />
            </button>

            {/* Widget Container */}
            {view === 'dashboard' && (
                <div className="fixed bottom-20 right-4 z-30 flex flex-col-reverse gap-3 items-end md:bottom-8 pointer-events-none">
                    <FinancialHealthWidget transactions={currentYearData} isVisible={widgets.health} onClose={() => toggleWidget('health')} currentYear={selectedYear} isDark={isDarkMode} />
                    <BudgetAlertWidget transactions={currentYearData} budgets={familyBudgets} isVisible={widgets.budgetAlert} onClose={() => toggleWidget('budgetAlert')} currentYear={selectedYear} isDark={isDarkMode} />
                    <TopExpensesWidget transactions={currentYearData} isVisible={widgets.topExpenses} onClose={() => toggleWidget('topExpenses')} currentYear={selectedYear} isDark={isDarkMode} />
                    <SavingsWidget transactions={currentYearData} isVisible={widgets.savings} onClose={() => toggleWidget('savings')} currentYear={selectedYear} isDark={isDarkMode} />
                </div>
            )}

            <div className={`md:hidden ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} border-t h-16 flex justify-around items-center px-2 z-50 fixed bottom-0 left-0 right-0`}>
                <button onClick={() => setView('dashboard')} className={`flex flex-col items-center gap-1 p-2 rounded-lg transition ${view === 'dashboard' ? 'text-[#008069]' : 'text-slate-400'}`}><PieChart className="w-6 h-6" /><span className="text-[10px] font-medium">Estado</span></button>
                <button onClick={() => setView('calendar')} className={`flex flex-col items-center gap-1 p-2 rounded-lg transition ${view === 'calendar' ? 'text-[#008069]' : 'text-slate-400'}`}><CalendarIcon className="w-6 h-6" /><span className="text-[10px] font-medium">Cal.</span></button>
                <button onClick={() => setView('history')} className={`flex flex-col items-center gap-1 p-2 rounded-lg transition ${view === 'history' ? 'text-[#008069]' : 'text-slate-400'}`}><Layers className="w-6 h-6" /><span className="text-[10px] font-medium">Historial</span></button>
            </div>
        </div>

        {isFormOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
                <div className={`w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up ${isDarkMode ? 'bg-slate-800' : 'bg-white'}`}>
                    <div className={`${THEME.primary} p-4 flex justify-between items-center text-white`}>
                        <h3 className="font-bold">{editingId ? 'Editar' : 'Nuevo'}</h3>
                        <button onClick={closeForm}><X className="w-5 h-5" /></button>
                    </div>
                    <form onSubmit={handleSubmit} className="p-6 space-y-6">
                        <div className={`flex p-1 rounded-xl ${isDarkMode ? 'bg-slate-700' : 'bg-slate-100'}`}>
                            {/* CORRECCIÓN: Botones actualizan tipo Y categoría por defecto */}
                            <button type="button" onClick={() => setFormData({...formData, type: 'income', category: 'Salario'})} className={`flex-1 py-2 text-sm font-bold rounded-lg transition ${formData.type === 'income' ? 'bg-white text-[#008069] shadow-sm' : 'text-slate-400'}`}>Ingreso</button>
                            <button type="button" onClick={() => setFormData({...formData, type: 'expense', category: 'Comida'})} className={`flex-1 py-2 text-sm font-bold rounded-lg transition ${formData.type === 'expense' ? 'bg-white text-red-500 shadow-sm' : 'text-slate-400'}`}>Gasto</button>
                        </div>
                        <div className="relative">
                            <span className={`absolute left-3 top-1/2 -translate-y-1/2 text-2xl font-light ${formData.type === 'income' ? 'text-[#008069]' : 'text-red-500'}`}>$</span>
                            <input type="number" step="0.01" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} className={`w-full text-center text-4xl font-bold bg-transparent border-b-2 outline-none pb-2 ${isDarkMode ? 'text-white border-slate-600' : 'text-slate-800 border-slate-100'}`} placeholder="0.00" autoFocus />
                        </div>
                        
                        {/* Selector de Miembro (Solo extra members) */}
                        <div className="text-center text-xs text-slate-400">
                            Registrando como: <span className="font-bold text-[#008069]">{currentUser.username}</span>
                        </div>
                        {currentFamily.members && currentFamily.members.length > 0 && (
                             <div className={`${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-200'} p-2 rounded-lg border`}>
                                <label className="text-[10px] uppercase font-bold text-slate-400 block mb-1">¿O es para alguien más?</label>
                                <select value={formData.memberId} onChange={e => setFormData({...formData, memberId: e.target.value})} className={`w-full bg-transparent text-sm font-semibold outline-none ${isDarkMode ? 'text-slate-200' : 'text-slate-700'}`}>
                                    <option value="" className={isDarkMode ? 'text-black' : ''}>{currentUser.username} (Yo)</option>
                                    {currentFamily.members.map(m => <option key={m.id} value={m.id} className={isDarkMode ? 'text-black' : ''}>{m.name}</option>)}
                                </select>
                            </div>
                        )}

                        <div className="grid grid-cols-2 gap-3">
                            <div className={`${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-200'} p-2 rounded-lg border`}>
                                <label className="text-[10px] uppercase font-bold text-slate-400 block mb-1">Categoría</label>
                                <select value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})} className={`w-full bg-transparent text-sm font-semibold outline-none ${isDarkMode ? 'text-slate-200' : 'text-slate-700'}`}>
                                    {formData.type === 'expense' ? (
                                        <><option>Comida</option><option>Transporte</option><option>Vivienda</option><option>Escuela</option><option>Despensa</option><option>Tienda</option><option>Comida a domicilio</option><option>Servicios</option><option>Deuda</option><option>Préstamos</option><option>Tarjetas de Crédito</option><option>Deuda Familiar</option><option>Gastos Hormiga</option><option>Otros</option></>
                                    ) : (
                                        <><option>Salario</option><option>Negocio</option><option>Ventas</option><option>Extra</option><option>Otros</option></>
                                    )}
                                </select>
                            </div>
                            <div className={`${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-200'} p-2 rounded-lg border`}>
                                <label className="text-[10px] uppercase font-bold text-slate-400 block mb-1">Fecha</label>
                                <input type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className={`w-full bg-transparent text-sm font-semibold outline-none ${isDarkMode ? 'text-slate-200' : 'text-slate-700'}`} />
                            </div>
                        </div>
                        <button type="submit" className={`w-full py-3 rounded-xl font-bold text-white shadow-md active:scale-95 transition ${formData.type === 'income' ? THEME.primary : 'bg-red-500'}`}>{editingId ? 'Actualizar' : 'Enviar'}</button>
                    </form>
                </div>
            </div>
        )}
        {deleteModal.show && (
            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
                <div className={`${isDarkMode ? 'bg-slate-800' : 'bg-white'} p-6 rounded-2xl shadow-xl max-w-xs w-full text-center space-y-4`}>
                    <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto text-red-500"><Trash2 /></div>
                    <h3 className={`font-bold ${isDarkMode ? 'text-slate-200' : 'text-slate-800'}`}>¿Eliminar mensaje?</h3>
                    <div className="flex gap-2">
                        <button onClick={() => setDeleteModal({show:false, id:null})} className={`flex-1 py-2 border rounded-xl ${isDarkMode ? 'text-slate-300 border-slate-600' : 'text-slate-600'}`}>Cancelar</button>
                        <button onClick={deleteItem} className="flex-1 py-2 bg-red-500 text-white rounded-xl">Eliminar</button>
                    </div>
                </div>
            </div>
        )}
    </div>
  );
};

export default App;
