<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Familiar</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React y ReactDOM -->
    <script type="importmap">
        {
          "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js",
            "firebase/analytics": "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"
          }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Ajuste para evitar zoom en inputs en iOS */
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="bg-[#efeae2] text-sm md:text-base selection:bg-green-100 selection:text-green-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Wallet, TrendingUp, TrendingDown, Calendar as CalendarIcon, 
            Edit2, Trash2, Save, X, PieChart, BarChart3, ChevronLeft, ChevronRight, 
            Layers, BarChart2, AlertTriangle, CalendarCheck, Activity, Lock, 
            CheckCircle2, PiggyBank, Minus, LogOut, User, Users, 
            Menu, Target, Home, KeyRound, UserPlus, Smile, Download, Moon, Sun,
            Mail, Copy, Share2
        } from 'lucide-react';
        
        import { initializeApp } from "firebase/app";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            deleteUser
        } from "firebase/auth";
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, where, 
            deleteDoc, doc, updateDoc, getDocs 
        } from "firebase/firestore";
        import { getAnalytics } from "firebase/analytics";

        // ------------------------------------------------------------------
        // CONFIGURACIÓN DE FIREBASE
        // ------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBI0r0YoRLZ6E-X7liiDaEPOdUi-bC13nI",
            authDomain: "mi-dominio-slayer.firebaseapp.com",
            databaseURL: "https://mi-dominio-slayer.firebaseio.com",
            projectId: "mi-dominio-slayer",
            storageBucket: "mi-dominio-slayer.firebasestorage.app",
            messagingSenderId: "18755592564",
            appId: "1:18755592564:web:b9a596068e88f136000c21",
            measurementId: "G-R4WCM2Q6C0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // --- TEMAS ---
        const THEME = {
            primary: 'bg-[#008069]', 
            secondary: 'bg-[#25D366]', 
            bg: 'bg-[#efeae2]', 
            white: 'bg-white',
            textPrimary: 'text-[#111b21]',
        };

        const getLocalDateStr = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const formatCurrency = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 0 }).format(amount);

        // --- COMPONENTES VISUALES ---
        const BarChartComponent = ({ title, data, maxVal, isDark }) => (
            <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} p-3 md:p-4 rounded-xl md:rounded-2xl shadow-sm border h-full flex flex-col transition-colors`}>
                <h3 className={`font-bold ${isDark ? 'text-slate-300' : 'text-[#54656f]'} mb-2 flex items-center gap-2 text-xs md:text-sm uppercase tracking-wider`}><BarChart2 className="w-3 h-3 md:w-4 md:h-4" /> {title}</h3>
                <div className="flex-1 flex items-end justify-between gap-1 md:gap-2 h-32 md:h-40 w-full">
                    {data.map((item, i) => (
                        <div key={i} className="flex flex-col items-center justify-end h-full w-full group relative">
                            <div className="flex gap-0.5 items-end h-full w-full justify-center">
                                <div className="w-1 md:w-2 bg-[#008069] rounded-t-sm opacity-80" style={{ height: `${maxVal > 0 ? (item.income / maxVal) * 100 : 0}%` }}></div>
                                <div className="w-1 md:w-2 bg-red-400 rounded-t-sm opacity-80" style={{ height: `${maxVal > 0 ? (item.expense / maxVal) * 100 : 0}%` }}></div>
                            </div>
                            <span className={`text-[8px] md:text-[9px] ${isDark ? 'text-slate-500' : 'text-slate-400'} mt-1 font-medium truncate w-full text-center`}>{item.label.charAt(0)}</span>
                        </div>
                    ))}
                </div>
            </div>
        );

        // --- WIDGETS ---
        const FloatingBalanceCard = ({ transactions, isVisible, onClose, currentYear, isDark }) => {
            const [isMinimized, setIsMinimized] = useState(false);
            if (!isVisible) return null;

            const now = new Date();
            const currentMonth = now.getMonth();
            let monthIncome = 0; let monthExpense = 0; let debtReserve = 0;
            const debtCategories = ['Deuda', 'Préstamos', 'Tarjetas de Crédito', 'Deuda Familiar'];

            transactions.forEach(t => {
                const tDate = new Date(t.date + 'T00:00:00');
                if (tDate.getFullYear() === currentYear && tDate.getMonth() === currentMonth) {
                    if (t.type === 'income') monthIncome += t.amount;
                    else {
                        const isDebt = debtCategories.includes(t.category);
                        const isFuture = tDate > new Date(now.setHours(0,0,0,0));
                        if (isDebt && isFuture) debtReserve += t.amount; else monthExpense += t.amount;
                    }
                }
            });

            const available = monthIncome - monthExpense;
            const net = available - debtReserve;
            const isGood = net >= 0;

            return (
                <div className={`${isDark ? 'bg-slate-800/95 border-slate-700' : 'bg-white/95 border-slate-200'} backdrop-blur-md border shadow-xl rounded-xl overflow-hidden transition-all duration-300 w-[90vw] md:w-72 pointer-events-auto mx-auto mb-2`}>
                    <div className={`p-2 md:p-3 flex justify-between items-center bg-gradient-to-r ${isGood ? 'from-[#008069] to-[#00a884]' : 'from-orange-500 to-red-500'}`}>
                        <div className="flex items-center gap-2 cursor-pointer w-full" onClick={() => setIsMinimized(!isMinimized)}>
                            <Activity className="w-3 h-3 text-white" />
                            <h4 className="text-white text-xs font-bold whitespace-nowrap">{isMinimized ? formatCurrency(net) : 'Estado Financiero'}</h4>
                        </div>
                        <div className="flex items-center gap-1 ml-3">
                            <button onClick={() => setIsMinimized(!isMinimized)} className="text-white/80 hover:text-white p-1"><Minus className="w-3 h-3" /></button>
                            <button onClick={onClose} className="text-white/80 hover:text-white p-1"><X className="w-3 h-3" /></button>
                        </div>
                    </div>
                    {!isMinimized && (
                        <div className="p-3 md:p-4 space-y-2 md:space-y-3">
                            <div className="flex justify-between items-center text-xs">
                                <span className={isDark ? 'text-slate-400' : 'text-slate-500'}>Operativo</span>
                                <span className={`font-bold ${isDark ? 'text-slate-200' : 'text-slate-700'}`}>{formatCurrency(available)}</span>
                            </div>
                            {debtReserve > 0 && (
                                <div className="flex justify-between items-center text-orange-600 bg-orange-50 p-1.5 rounded-lg text-xs">
                                    <span className="flex items-center gap-1"><Lock className="w-3 h-3"/> Reserva</span>
                                    <span className="font-bold">- {formatCurrency(debtReserve)}</span>
                                </div>
                            )}
                            <div className={`pt-2 border-t ${isDark ? 'border-slate-700' : 'border-slate-100'} mt-1 text-center ${isGood ? 'text-[#008069]' : 'text-red-500'}`}>
                                <p className="text-[10px] uppercase font-bold tracking-wider">{isGood ? 'Libre' : 'Falta'}</p>
                                <p className="text-lg md:text-xl font-black">{formatCurrency(Math.abs(net))}</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const BudgetAlertWidget = ({ transactions, budgets, isVisible, onClose, currentYear, isDark }) => {
            const [isMinimized, setIsMinimized] = useState(false);
            if (!isVisible || !budgets || budgets.length === 0) return null;
            const currentMonth = new Date().getMonth();
            const currentMonthExpenses = {};
            transactions.forEach(t => {
                const tDate = new Date(t.date + 'T00:00:00');
                if (t.type === 'expense' && tDate.getFullYear() === currentYear && tDate.getMonth() === currentMonth) {
                    currentMonthExpenses[t.category] = (currentMonthExpenses[t.category] || 0) + t.amount;
                }
            });
            const alerts = budgets.filter(b => (currentMonthExpenses[b.category] || 0) >= (b.limit * 0.8)).map(b => ({ ...b, spent: currentMonthExpenses[b.category] || 0, percentage: ((currentMonthExpenses[b.category] || 0) / b.limit) * 100 }));
            if (alerts.length === 0) return null;
            return (
                <div className={`${isDark ? 'bg-slate-800/95 border-slate-700' : 'bg-white/95 border-slate-200'} backdrop-blur-md border shadow-xl rounded-xl overflow-hidden transition-all duration-300 w-[90vw] md:w-72 mt-2 pointer-events-auto`}>
                    <div className="p-2 md:p-3 flex justify-between items-center bg-amber-500">
                        <div className="flex items-center gap-2 cursor-pointer w-full" onClick={() => setIsMinimized(!isMinimized)}>
                            <AlertTriangle className="w-3 h-3 text-white" />
                            <h4 className="text-white text-xs font-bold whitespace-nowrap">Alertas</h4>
                        </div>
                        <div className="flex items-center gap-1 ml-2">
                            <button onClick={() => setIsMinimized(!isMinimized)} className="text-white/80 hover:text-white p-1"><Minus className="w-3 h-3" /></button>
                            <button onClick={onClose} className="text-white/80 hover:text-white p-1"><X className="w-3 h-3" /></button>
                        </div>
                    </div>
                    {!isMinimized && (
                        <div className="p-3 md:p-4 space-y-2">
                            {alerts.map((alert, idx) => (
                                <div key={idx} className="text-xs">
                                    <div className="flex justify-between mb-1">
                                        <span className={`font-bold ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>{alert.category}</span>
                                        <span className={`font-bold ${alert.percentage >= 100 ? 'text-red-500' : 'text-amber-600'}`}>{Math.round(alert.percentage)}%</span>
                                    </div>
                                    <div className={`w-full h-1.5 rounded-full ${isDark ? 'bg-slate-700' : 'bg-slate-100'}`}><div className={`h-full rounded-full ${alert.percentage >= 100 ? 'bg-red-500' : 'bg-amber-500'}`} style={{ width: `${Math.min(alert.percentage, 100)}%` }}></div></div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const TopExpensesWidget = ({ transactions, isVisible, onClose, currentYear, isDark }) => {
            const [isMinimized, setIsMinimized] = useState(false);
            if (!isVisible) return null;
            const currentMonth = new Date().getMonth();
            const expensesByCategory = {};
            let totalExpense = 0;
            transactions.forEach(t => {
                const tDate = new Date(t.date + 'T00:00:00');
                if (t.type === 'expense' && tDate.getFullYear() === currentYear && tDate.getMonth() === currentMonth) {
                    expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
                    totalExpense += t.amount;
                }
            });
            const sortedCategories = Object.entries(expensesByCategory).sort(([, a], [, b]) => b - a).slice(0, 3);
            return (
                <div className={`${isDark ? 'bg-slate-800/95 border-slate-700' : 'bg-white/95 border-slate-200'} backdrop-blur-md border shadow-xl rounded-xl overflow-hidden transition-all duration-300 w-[90vw] md:w-72 mt-2 pointer-events-auto`}>
                    <div className={`p-2 md:p-3 flex justify-between items-center ${isDark ? 'bg-slate-900' : 'bg-slate-700'}`}>
                        <div className="flex items-center gap-2 cursor-pointer w-full" onClick={() => setIsMinimized(!isMinimized)}><TrendingDown className="w-3 h-3 text-white" /><h4 className="text-white text-xs font-bold whitespace-nowrap">Top Gastos</h4></div>
                        <div className="flex items-center gap-1 ml-2"><button onClick={() => setIsMinimized(!isMinimized)} className="text-white/80 hover:text-white p-1"><Minus className="w-3 h-3" /></button><button onClick={onClose} className="text-white/80 hover:text-white p-1"><X className="w-3 h-3" /></button></div>
                    </div>
                    {!isMinimized && (
                        <div className="p-3 md:p-4 space-y-2">
                            {sortedCategories.length > 0 ? sortedCategories.map(([cat, amount], i) => (
                                <div key={cat} className="flex items-center justify-between text-xs">
                                    <div className="flex items-center gap-2"><span className="font-bold text-slate-400 w-3">#{i+1}</span><span className={`font-medium ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>{cat}</span></div>
                                    <div className={`font-bold ${isDark ? 'text-slate-200' : 'text-slate-800'}`}>{formatCurrency(amount)}</div>
                                </div>
                            )) : <p className="text-xs text-slate-400 text-center">Sin datos.</p>}
                        </div>
                    )}
                </div>
            );
        };

        const SavingsWidget = ({ transactions, isVisible, onClose, currentYear, isDark }) => {
            const [isMinimized, setIsMinimized] = useState(false);
            const [goal, setGoal] = useState(() => localStorage.getItem('savingsGoal') || 10000);
            const [isEditing, setIsEditing] = useState(false);
            const [tempGoal, setTempGoal] = useState(goal);
            if (!isVisible) return null;
            const saveGoal = () => { setGoal(tempGoal); localStorage.setItem('savingsGoal', tempGoal); setIsEditing(false); };
            let totalIncome = 0; let totalExpense = 0;
            transactions.forEach(t => {
                const tDate = new Date(t.date + 'T00:00:00');
                if (tDate.getFullYear() === currentYear) {
                    if (t.type === 'income') totalIncome += t.amount; else totalExpense += t.amount;
                }
            });
            const currentSavings = totalIncome - totalExpense;
            const progress = Math.min((currentSavings / goal) * 100, 100);
            return (
                <div className={`${isDark ? 'bg-slate-800/95 border-slate-700' : 'bg-white/95 border-slate-200'} backdrop-blur-md border shadow-xl rounded-xl overflow-hidden transition-all duration-300 w-[90vw] md:w-72 mt-2 pointer-events-auto`}>
                    <div className="p-2 md:p-3 flex justify-between items-center bg-indigo-600">
                        <div className="flex items-center gap-2 cursor-pointer w-full" onClick={() => setIsMinimized(!isMinimized)}><Target className="w-3 h-3 text-white" /><h4 className="text-white text-xs font-bold whitespace-nowrap">Meta {currentYear}</h4></div>
                        <div className="flex items-center gap-1 ml-2"><button onClick={() => setIsMinimized(!isMinimized)} className="text-white/80 hover:text-white p-1"><Minus className="w-3 h-3" /></button><button onClick={onClose} className="text-white/80 hover:text-white p-1"><X className="w-3 h-3" /></button></div>
                    </div>
                    {!isMinimized && (
                        <div className="p-3 md:p-4">
                            <div className="flex justify-between items-end mb-1">
                                <p className={`text-lg font-bold ${currentSavings >= 0 ? 'text-indigo-500' : 'text-red-500'}`}>{formatCurrency(currentSavings)}</p>
                                {isEditing ? <div className="flex items-center gap-1"><input type="number" className="w-14 text-xs border rounded px-1 outline-none text-black" value={tempGoal} onChange={(e) => setTempGoal(e.target.value)}/><button onClick={saveGoal} className="text-green-500"><CheckCircle2 className="w-4 h-4"/></button></div> : <p className={`text-xs font-semibold ${isDark ? 'text-slate-300' : 'text-slate-600'} cursor-pointer flex items-center gap-1`} onClick={() => setIsEditing(true)}>{formatCurrency(goal)} <Edit2 className="w-3 h-3 opacity-50"/></p>}
                            </div>
                            <div className={`w-full ${isDark ? 'bg-slate-700' : 'bg-slate-100'} h-1.5 rounded-full overflow-hidden mb-1`}><div className="bg-indigo-500 h-full rounded-full transition-all duration-1000" style={{ width: `${Math.max(0, progress)}%` }}></div></div>
                        </div>
                    )}
                </div>
            );
        };

        const CalendarView = ({ transactions, selectedYear, onDateClick, isDark }) => {
            const [date, setDate] = useState(new Date(selectedYear, new Date().getMonth(), 1));
            useEffect(() => { if (date.getFullYear() !== selectedYear) setDate(new Date(selectedYear, 0, 1)); }, [selectedYear]);
            const getDaysInMonth = (d) => {
                const year = d.getFullYear(); const month = d.getMonth(); const days = new Date(year, month + 1, 0).getDate(); const firstDay = new Date(year, month, 1).getDay(); return { days, firstDay };
            };
            const { days, firstDay } = getDaysInMonth(date);
            const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
            const changeMonth = (offset) => { const newDate = new Date(date); newDate.setMonth(newDate.getMonth() + offset); setDate(newDate); };
            const getDayData = (day) => {
                const month = String(date.getMonth() + 1).padStart(2, '0'); const dateStr = `${date.getFullYear()}-${month}-${String(day).padStart(2, '0')}`;
                const dayTransactions = transactions.filter(t => t.date === dateStr);
                const income = dayTransactions.filter(t => t.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
                const expense = dayTransactions.filter(t => t.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);
                return { income, expense };
            };

            return (
                <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} rounded-2xl shadow-sm border overflow-hidden animate-fade-in mb-20 transition-colors`}>
                    <div className={`p-3 md:p-4 ${isDark ? 'bg-slate-900 border-slate-700' : 'bg-slate-50 border-slate-200'} flex justify-between items-center border-b`}>
                        <button onClick={() => changeMonth(-1)} className="p-1 md:p-2 hover:opacity-70 rounded-full text-slate-500"><ChevronLeft className="w-5 h-5"/></button>
                        <div className="flex items-center gap-2"><span className={`font-bold text-sm md:text-base ${isDark ? 'text-slate-200' : 'text-slate-700'}`}>{monthNames[date.getMonth()]} {date.getFullYear()}</span><button onClick={() => setDate(new Date())} className="text-[#008069] bg-[#d9fdd3] p-1 rounded-md text-[10px] md:text-xs font-bold px-2">Hoy</button></div>
                        <button onClick={() => changeMonth(1)} className="p-1 md:p-2 hover:opacity-70 rounded-full text-slate-500"><ChevronRight className="w-5 h-5"/></button>
                    </div>
                    <div className="p-2 md:p-3">
                        <div className="grid grid-cols-7 mb-2 text-center text-[10px] md:text-xs font-bold text-slate-400">{['D','L','M','M','J','V','S'].map((d, i) => <div key={i} className="py-1">{d}</div>)}</div>
                        <div className="grid grid-cols-7 gap-1">
                            {[...Array(firstDay)].map((_, i) => <div key={`empty-${i}`} className="aspect-square"></div>)}
                            {[...Array(days)].map((_, i) => {
                                const day = i + 1; const { income, expense } = getDayData(day); const balance = income - expense;
                                const isToday = new Date().toDateString() === new Date(date.getFullYear(), date.getMonth(), day).toDateString();
                                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                const hasData = income > 0 || expense > 0;
                                return (
                                    <button key={day} onClick={() => onDateClick(dateStr)} className={`relative min-h-[50px] md:min-h-[70px] border rounded-lg p-1 flex flex-col justify-between transition hover:border-[#008069] ${isToday ? 'bg-[#e7f5f2] border-[#008069]' : isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                                        <span className={`text-[9px] md:text-[10px] font-bold ${isToday ? 'text-[#008069]' : 'text-slate-400'}`}>{day}</span>
                                        {hasData && (
                                            <div className="w-full text-center"><div className="flex justify-center gap-0.5 mb-0.5">{income > 0 && <div className="w-1 md:w-1.5 h-1 md:h-1.5 rounded-full bg-[#008069]"></div>}{expense > 0 && <div className="w-1 md:w-1.5 h-1 md:h-1.5 rounded-full bg-red-500"></div>}</div><span className={`block text-[8px] md:text-[9px] font-bold leading-tight ${balance >= 0 ? 'text-[#008069]' : 'text-red-500'}`}>{formatCurrency(Math.abs(balance))}</span></div>
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const HistoryView = ({ transactions, onEdit, onDelete, isDark }) => {
            const grouped = {};
            const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            sorted.forEach(t => { if (!grouped[t.date]) grouped[t.date] = []; grouped[t.date].push(t); });
            return (
                <div className="space-y-4 pb-24 animate-fade-in">
                    {Object.keys(grouped).length === 0 && <div className="text-center py-10 text-slate-400 opacity-50"><Layers className="w-10 h-10 mx-auto mb-2" /><p className="text-xs">Sin movimientos</p></div>}
                    {Object.entries(grouped).map(([date, items]) => (
                        <div key={date}>
                            <div className="flex justify-center mb-2"><span className="bg-[#e1f3fb] text-slate-600 text-[9px] md:text-[10px] font-bold px-3 py-1 rounded-full shadow-sm">{new Date(date + 'T00:00:00').toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' })}</span></div>
                            <div className="space-y-1.5">
                                {items.map(t => (
                                    <div key={t.id} onClick={() => onEdit(t)} className={`relative flex flex-col p-2.5 md:p-3 rounded-lg shadow-sm border border-transparent hover:border-slate-200 transition cursor-pointer ${t.type === 'income' ? (isDark ? 'bg-slate-800 text-slate-200 ml-0 mr-4 md:mr-8 rounded-tl-none' : 'bg-white ml-0 mr-4 md:mr-8 rounded-tl-none') : 'bg-[#d9fdd3] ml-4 md:ml-8 mr-0 rounded-tr-none'}`}>
                                        <div className="flex justify-between items-start">
                                            <div className="flex items-center gap-2 mb-1">
                                                <div className="w-4 h-4 md:w-5 md:h-5 rounded-full flex items-center justify-center text-[8px] md:text-[9px] font-bold text-white shadow-sm" style={{ backgroundColor: t.userColor || '#ccc' }}>{t.userName ? t.userName.charAt(0).toUpperCase() : '?'}</div>
                                                <span className={`text-[10px] md:text-xs font-bold ${t.type === 'income' ? 'text-[#008069]' : 'text-slate-700'}`}>{t.category}</span>
                                            </div>
                                            <span className={`text-xs md:text-sm font-bold ${t.type === 'income' ? (isDark ? 'text-slate-300' : 'text-slate-600') : 'text-slate-800'}`}>{t.type === 'income' ? '+ ' : '- '}{formatCurrency(t.amount)}</span>
                                        </div>
                                        <div className="flex justify-between items-end mt-1"><p className="text-[9px] md:text-[10px] text-slate-500 line-clamp-1">{t.userName} • {t.type === 'expense' ? 'Gasto' : 'Ingreso'}</p><div className="flex gap-2"><button onClick={(e) => { e.stopPropagation(); onDelete(t.id); }} className="text-slate-300 hover:text-red-400 transition"><Trash2 className="w-3 h-3" /></button></div></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const MembersView = ({ family, familyMembers, isDark }) => {
            const [newMemberName, setNewMemberName] = useState('');
            const addMember = async (e) => {
                e.preventDefault();
                if (!newMemberName.trim()) return;
                const colors = ['#EF4444', '#F97316', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#8B5CF6'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                await addDoc(collection(db, 'members'), { familyId: family.id, name: newMemberName.trim(), color: randomColor, isVirtual: true });
                setNewMemberName('');
            };
            const copyCode = () => { navigator.clipboard.writeText(family.joinCode); alert("Copiado"); };

            return (
                <div className="space-y-4 md:space-y-6 pb-24 animate-fade-in">
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 md:p-6 rounded-xl md:rounded-2xl shadow-lg text-white">
                        <div className="flex justify-between items-start mb-4">
                            <div><h3 className="text-base md:text-lg font-bold flex items-center gap-2"><Share2 className="w-4 h-4 md:w-5 md:h-5"/> Invitar</h3><p className="text-blue-100 text-[10px] md:text-xs mt-1">Comparte este código:</p></div>
                            <div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm"><KeyRound className="w-5 h-5 md:w-6 md:h-6" /></div>
                        </div>
                        <div className="bg-white/10 border border-white/20 rounded-xl p-3 flex items-center justify-between"><span className="text-lg md:text-2xl font-mono font-bold tracking-widest">{family.joinCode}</span><button onClick={copyCode} className="bg-white text-blue-600 p-2 rounded-lg hover:bg-blue-50 transition"><Copy className="w-4 h-4"/></button></div>
                    </div>
                    <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} p-4 md:p-6 rounded-xl md:rounded-2xl shadow-sm border transition-colors`}>
                        <h3 className={`font-bold ${isDark ? 'text-slate-200' : 'text-slate-700'} mb-4 flex items-center gap-2`}><Users className="w-4 h-4 md:w-5 md:h-5 text-[#008069]" /> Integrantes</h3>
                        <div className="space-y-2 mb-6">
                            {familyMembers.length > 0 ? familyMembers.map(member => (
                                <div key={member.id} className={`flex items-center justify-between p-2 md:p-3 ${isDark ? 'bg-slate-700/50 border-slate-700' : 'bg-slate-50 border-slate-100'} rounded-xl border`}>
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center text-white font-bold shadow-sm text-xs" style={{ backgroundColor: member.color }}>{member.name.charAt(0).toUpperCase()}</div>
                                        <div><span className={`font-medium block text-xs md:text-sm ${isDark ? 'text-slate-200' : 'text-slate-800'}`}>{member.name}</span><span className={`text-[9px] md:text-[10px] uppercase px-1.5 py-0.5 rounded ${member.isVirtual ? 'bg-amber-100 text-amber-700' : 'bg-green-100 text-green-700'}`}>{member.isVirtual ? 'Virtual' : 'App'}</span></div>
                                    </div>
                                </div>
                            )) : <p className="text-slate-400 text-center text-sm">Cargando...</p>}
                        </div>
                        <div className={`pt-4 border-t ${isDark ? 'border-slate-700' : 'border-slate-100'}`}>
                            <p className={`text-xs mb-3 ${isDark ? 'text-slate-400' : 'text-slate-500'}`}>Agregar miembro (sin app)</p>
                            <form onSubmit={addVirtualMember} className="flex gap-2">
                                <input type="text" value={newMemberName} onChange={(e) => setNewMemberName(e.target.value)} placeholder="Nombre..." className={`flex-1 ${isDark ? 'bg-slate-700 text-slate-200 border-slate-600' : 'bg-slate-50 text-slate-700 border-slate-200'} border rounded-xl px-4 py-2 outline-none focus:border-[#008069] text-sm`} />
                                <button type="submit" className="bg-[#008069] text-white p-2 rounded-xl hover:bg-[#005c4b]"><UserPlus className="w-4 h-4 md:w-5 md:h-5" /></button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardView = ({ transactions, isDark }) => {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const monthlyData = Array(12).fill(0).map((_, i) => {
                const mTrans = transactions.filter(t => new Date(t.date+'T00:00:00').getMonth() === i);
                return {
                    label: new Date(2000, i, 1).toLocaleString('es-MX', { month: 'short' }),
                    income: mTrans.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0),
                    expense: mTrans.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0)
                };
            });
            const maxVal = Math.max(...monthlyData.map(d => Math.max(d.income, d.expense))) || 100;
            return (
                <div className="space-y-4 animate-fade-in pb-24">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} p-4 rounded-xl md:rounded-2xl shadow-sm border flex flex-col justify-between h-24 md:h-28 relative overflow-hidden`}>
                            <div className="absolute top-0 right-0 p-3 opacity-10"><Wallet className="w-10 h-10 md:w-12 md:h-12 text-[#008069]" /></div>
                            <p className="text-xs font-bold text-slate-400 uppercase">Balance</p>
                            <p className={`text-2xl md:text-3xl font-black ${income - expense >= 0 ? (isDark ? 'text-slate-200' : 'text-[#111b21]') : 'text-red-500'}`}>{formatCurrency(income - expense)}</p>
                        </div>
                        <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} p-4 rounded-xl md:rounded-2xl shadow-sm border flex items-center justify-between`}>
                            <div><p className="text-xs text-slate-400 font-bold uppercase">Ingresos</p><p className="text-lg md:text-xl font-bold text-[#008069]">{formatCurrency(income)}</p></div>
                            <div className="bg-[#d9fdd3] p-2 rounded-full"><TrendingUp className="w-4 h-4 md:w-5 md:h-5 text-[#008069]" /></div>
                        </div>
                        <div className={`${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} p-4 rounded-xl md:rounded-2xl shadow-sm border flex items-center justify-between`}>
                            <div><p className="text-xs text-slate-400 font-bold uppercase">Gastos</p><p className="text-lg md:text-xl font-bold text-red-500">{formatCurrency(expense)}</p></div>
                            <div className="bg-red-50 p-2 rounded-full"><TrendingDown className="w-4 h-4 md:w-5 md:h-5 text-red-500" /></div>
                        </div>
                    </div>
                    <div className="h-48 md:h-64">
                        <BarChartComponent title={`Flujo Anual`} data={monthlyData} maxVal={maxVal} isDark={isDark} />
                    </div>
                </div>
            );
        };

        const AuthScreen = ({ onLogin }) => {
            const [mode, setMode] = useState('login'); 
            const [data, setData] = useState({ email: '', password: '', familyName: '', joinCode: '', userName: '' });
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                try {
                    const auth = getAuth();
                    const db = getFirestore();
                    if (mode === 'login') {
                        await signInWithEmailAndPassword(auth, data.email, data.password);
                    } else if (mode === 'register') {
                        const userCredential = await createUserWithEmailAndPassword(auth, data.email, data.password);
                        const user = userCredential.user;
                        const newJoinCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                        const familyRef = await addDoc(collection(db, 'families'), { name: data.familyName, joinCode: newJoinCode, createdAt: new Date().toISOString(), createdBy: user.uid });
                        await addDoc(collection(db, 'members'), { uid: user.uid, familyId: familyRef.id, name: data.userName, email: data.email, role: 'admin', color: `hsl(${Math.random() * 360}, 70%, 40%)`, isVirtual: false });
                    } else if (mode === 'join') {
                        const userCredential = await createUserWithEmailAndPassword(auth, data.email, data.password);
                        const user = userCredential.user;
                        const q = query(collection(db, 'families'), where('joinCode', '==', data.joinCode));
                        const snapshot = await getDocs(q);
                        if (snapshot.empty) { await deleteUser(user); throw new Error("Código inválido"); }
                        const familyDoc = snapshot.docs[0];
                        await addDoc(collection(db, 'members'), { uid: user.uid, familyId: familyDoc.id, name: data.userName, email: data.email, role: 'member', color: `hsl(${Math.random() * 360}, 70%, 40%)`, isVirtual: false });
                    }
                } catch (err) {
                    console.error(err);
                    setError(err.message.includes("auth") ? "Error de credenciales" : err.message);
                    setLoading(false);
                }
            };

            return (
                <div className={`min-h-screen flex items-center justify-center ${THEME.bg} p-4`}>
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-xl overflow-hidden">
                        <div className={`${THEME.primary} p-6 md:p-8 text-center`}>
                            <div className="w-14 h-14 md:w-16 md:h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm"><Users className="w-7 h-7 md:w-8 md:h-8 text-white" /></div>
                            <h1 className="text-xl md:text-2xl font-bold text-white mb-1">Control Familiar</h1>
                            <p className="text-white/80 text-xs md:text-sm">Finanzas compartidas</p>
                        </div>
                        <div className="flex border-b border-gray-100">
                            {['login', 'register', 'join'].map(m => (
                                <button key={m} onClick={() => {setMode(m); setError('');}} className={`flex-1 py-3 text-xs md:text-sm font-bold capitalize ${mode === m ? 'text-[#008069] border-b-2 border-[#008069]' : 'text-gray-400'}`}>
                                    {m === 'login' ? 'Entrar' : m === 'register' ? 'Crear' : 'Unirse'}
                                </button>
                            ))}
                        </div>
                        <div className="p-6 md:p-8">
                            <form onSubmit={handleAuth} className="space-y-4">
                                <div className="space-y-3">
                                    <div className="flex items-center border-b border-gray-200 py-2"><Mail className="w-4 h-4 md:w-5 md:h-5 text-gray-400 mr-2" /><input type="email" required value={data.email} onChange={(e) => setData({...data, email: e.target.value})} className="w-full outline-none text-gray-700 bg-transparent text-sm" placeholder="Correo" /></div>
                                    <div className="flex items-center border-b border-gray-200 py-2"><Lock className="w-4 h-4 md:w-5 md:h-5 text-gray-400 mr-2" /><input type="password" required value={data.password} onChange={(e) => setData({...data, password: e.target.value})} className="w-full outline-none text-gray-700 bg-transparent text-sm" placeholder="Contraseña" /></div>
                                </div>
                                {mode === 'register' && (
                                    <div className="mt-4 p-3 bg-blue-50 rounded-xl border border-blue-100 animate-fade-in">
                                        <input type="text" required value={data.userName} onChange={(e) => setData({...data, userName: e.target.value})} className="w-full outline-none text-blue-900 bg-transparent border-b border-blue-200 py-1 mb-2 text-sm" placeholder="Tu Nombre" />
                                        <input type="text" required value={data.familyName} onChange={(e) => setData({...data, familyName: e.target.value})} className="w-full outline-none text-blue-900 bg-transparent border-b border-blue-200 py-1 text-sm" placeholder="Nombre Familia" />
                                    </div>
                                )}
                                {mode === 'join' && (
                                    <div className="mt-4 p-3 bg-orange-50 rounded-xl border border-orange-100 animate-fade-in">
                                        <input type="text" required value={data.userName} onChange={(e) => setData({...data, userName: e.target.value})} className="w-full outline-none text-orange-900 bg-transparent border-b border-orange-200 py-1 mb-2 text-sm" placeholder="Tu Nombre" />
                                        <input type="text" required value={data.joinCode} onChange={(e) => setData({...data, joinCode: e.target.value.toUpperCase()})} className="w-full outline-none text-orange-900 bg-transparent border-b border-orange-200 py-1 font-mono tracking-widest text-sm" placeholder="CÓDIGO" />
                                    </div>
                                )}
                                {error && <p className="text-red-500 text-xs font-medium text-center bg-red-50 p-2 rounded-lg">{error}</p>}
                                <button type="submit" disabled={loading} className={`w-full ${THEME.primary} text-white py-3 rounded-xl font-bold shadow-lg hover:opacity-90 transition transform active:scale-95 disabled:opacity-50 text-sm`}>{loading ? '...' : 'Continuar'}</button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null); 
            const [memberProfile, setMemberProfile] = useState(null); 
            const [family, setFamily] = useState(null); 
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [transactions, setTransactions] = useState([]);
            const [familyMembers, setFamilyMembers] = useState([]);
            const [budgets, setBudgets] = useState([]);
            const [isFormOpen, setIsFormOpen] = useState(false);
            const initialFormState = { amount: '', type: 'expense', category: 'Comida', date: getLocalDateStr(new Date()), memberId: '' };
            const [formData, setFormData] = useState(initialFormState);
            const [editingId, setEditingId] = useState(null);
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [widgets, setWidgets] = useState({ health: true, topExpenses: true, savings: true, budgetAlert: true });
            const [deleteModal, setDeleteModal] = useState({ show: false, id: null });

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u);
                        const q = query(collection(db, 'members'), where('uid', '==', u.uid));
                        const snapshot = await getDocs(q);
                        if (!snapshot.empty) {
                            const memData = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                            setMemberProfile(memData);
                        }
                    } else { setUser(null); setMemberProfile(null); setFamily(null); }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!memberProfile) return;
                const unsubFamily = onSnapshot(doc(db, 'families', memberProfile.familyId), (doc) => { if(doc.exists()) setFamily({ id: doc.id, ...doc.data() }); });
                const unsubMembers = onSnapshot(query(collection(db, 'members'), where('familyId', '==', memberProfile.familyId)), (s) => setFamilyMembers(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubTrans = onSnapshot(query(collection(db, 'transactions'), where('familyId', '==', memberProfile.familyId)), (s) => setTransactions(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubBudgets = onSnapshot(query(collection(db, 'budgets'), where('familyId', '==', memberProfile.familyId)), (s) => setBudgets(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                return () => { unsubFamily(); unsubMembers(); unsubTrans(); unsubBudgets(); };
            }, [memberProfile]);

            const handleLogout = async () => { await signOut(auth); };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.amount) return;
                let targetMember = memberProfile; 
                if (formData.memberId) { const found = familyMembers.find(m => m.id === formData.memberId); if (found) targetMember = found; }
                const newTransaction = { familyId: family.id, ...formData, amount: parseFloat(formData.amount), userId: user.uid, userName: targetMember.name, userColor: targetMember.color, createdAt: new Date().toISOString() };
                if (editingId) await updateDoc(doc(db, 'transactions', editingId), newTransaction);
                else await addDoc(collection(db, 'transactions'), newTransaction);
                closeForm();
            };

            const deleteTransaction = async (id) => { await deleteDoc(doc(db, 'transactions', id)); };
            const openForm = (t = null, date = null) => {
                if (t) { setFormData({ ...t, memberId: '' }); setEditingId(t.id); } 
                else { 
                    const d = date || getLocalDateStr(new Date());
                    const type = date ? 'income' : 'expense';
                    setFormData({ ...initialFormState, date: d, type, category: type === 'income' ? 'Salario' : 'Comida', memberId: '' }); 
                    setEditingId(null);
                }
                setIsFormOpen(true);
            };
            const closeForm = () => { setIsFormOpen(false); setEditingId(null); };
            const toggleWidget = (key) => setWidgets(prev => ({ ...prev, [key]: !prev[key] }));
            const toggleDarkMode = () => setIsDarkMode(!isDarkMode);
            const currentYearData = transactions.filter(t => new Date(t.date + 'T00:00:00').getFullYear() === selectedYear);

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-[#efeae2]"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#008069]"></div></div>;
            if (!user || !memberProfile || !family) return <AuthScreen onLogin={() => {}} />;

            const BgColor = isDarkMode ? 'bg-slate-900' : THEME.bg;
            const TextColor = isDarkMode ? 'text-slate-200' : 'text-slate-800';
            const CardBg = isDarkMode ? 'bg-slate-800' : 'bg-white';
            const BorderColor = isDarkMode ? 'border-slate-700' : 'border-slate-200';

            return (
                <div className={`min-h-screen ${BgColor} ${TextColor} font-sans flex overflow-hidden transition-colors duration-300`}>
                    <aside className={`fixed inset-y-0 left-0 z-50 w-72 ${CardBg} border-r ${BorderColor} transform transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:static flex flex-col`}>
                        <div className={`h-16 ${isDarkMode ? 'bg-slate-900' : 'bg-[#f0f2f5]'} flex items-center px-4 justify-between border-b ${BorderColor}`}>
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold shadow-sm text-xs" style={{ backgroundColor: memberProfile.color }}>{memberProfile.name.charAt(0).toUpperCase()}</div>
                                <div className="overflow-hidden"><p className={`text-sm font-bold ${TextColor} truncate w-32`}>{memberProfile.name}</p><p className="text-[10px] opacity-60 truncate">{family.name}</p></div>
                            </div>
                            <div className="flex gap-1">
                                <button onClick={handleLogout} className="p-2 opacity-60 hover:opacity-100 transition"><LogOut className="w-4 h-4" /></button>
                                <button onClick={() => setIsSidebarOpen(false)} className="p-2 md:hidden"><X className="w-5 h-5"/></button>
                            </div>
                        </div>
                        <div className="p-4 flex-1 overflow-y-auto">
                            <div className="mb-6">
                                <h3 className="text-xs font-bold text-[#008069] uppercase mb-2 px-2">Menú</h3>
                                <nav className="space-y-1">
                                    <button onClick={() => { setView('dashboard'); setIsSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition ${view === 'dashboard' ? 'bg-[#e7f5f2] text-[#008069]' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}><PieChart className="w-4 h-4" /> Resumen</button>
                                    <button onClick={() => { setView('calendar'); setIsSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition ${view === 'calendar' ? 'bg-[#e7f5f2] text-[#008069]' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}><CalendarIcon className="w-4 h-4" /> Calendario</button>
                                    <button onClick={() => { setView('history'); setIsSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition ${view === 'history' ? 'bg-[#e7f5f2] text-[#008069]' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}><Layers className="w-4 h-4" /> Historial</button>
                                    <button onClick={() => { setView('budgets'); setIsSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition ${view === 'budgets' ? 'bg-[#e7f5f2] text-[#008069]' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}><PiggyBank className="w-4 h-4" /> Presupuestos</button>
                                    <button onClick={() => { setView('members'); setIsSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition ${view === 'members' ? 'bg-[#e7f5f2] text-[#008069]' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}><Users className="w-4 h-4" /> Miembros</button>
                                </nav>
                            </div>
                            <div className="mb-6"><button onClick={toggleDarkMode} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition hover:bg-slate-100 dark:hover:bg-slate-700 ${TextColor}`}>{isDarkMode ? <Sun className="w-4 h-4" /> : <Moon className="w-4 h-4" />} {isDarkMode ? 'Modo Claro' : 'Modo Oscuro'}</button></div>
                            <div className="mb-6">
                                <h3 className="text-xs font-bold text-[#008069] uppercase mb-2 px-2">Widgets</h3>
                                <div className={`${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-100'} rounded-xl p-3 space-y-3 border`}>
                                    {[{k:'health',l:'Estado',i:Activity}, {k:'topExpenses',l:'Top Gastos',i:TrendingDown}, {k:'savings',l:'Ahorro',i:Target}, {k:'budgetAlert',l:'Alertas',i:AlertTriangle}].map(w => (
                                        <label key={w.k} className="flex items-center justify-between cursor-pointer group"><span className={`text-sm flex items-center gap-2 ${TextColor}`}><w.i className="w-4 h-4 opacity-50" /> {w.l}</span><div className={`w-9 h-5 flex items-center bg-gray-300 rounded-full p-1 duration-300 ease-in-out ${widgets[w.k] ? 'bg-[#008069]' : ''}`} onClick={() => toggleWidget(w.k)}><div className={`bg-white w-3 h-3 rounded-full shadow-md transform duration-300 ease-in-out ${widgets[w.k] ? 'translate-x-4' : ''}`}></div></div></label>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </aside>

                    {isSidebarOpen && <div className="fixed inset-0 bg-black/30 z-40 md:hidden backdrop-blur-sm" onClick={() => setIsSidebarOpen(false)}></div>}

                    <div className="flex-1 flex flex-col h-screen relative w-full overflow-hidden">
                        <header className={`${THEME.primary} h-16 flex items-center justify-between px-4 shadow-md z-20`}>
                            <div className="flex items-center gap-3"><button onClick={() => setIsSidebarOpen(true)} className="md:hidden text-white p-1"><Menu className="w-6 h-6" /></button><div className="flex flex-col"><h1 className="text-white font-bold text-base md:text-lg leading-tight truncate max-w-[150px]">{family.name}</h1><p className="text-white/70 text-[10px] md:text-xs">Control de Gastos</p></div></div>
                            <div className="flex items-center bg-black/10 rounded-full px-2 py-1"><button onClick={() => setSelectedYear(y => y - 1)} className="text-white/70 hover:text-white"><ChevronLeft className="w-4 h-4" /></button><span className="px-2 text-xs md:text-sm font-medium text-white">{selectedYear}</span><button onClick={() => setSelectedYear(y => y + 1)} className="text-white/70 hover:text-white"><ChevronRight className="w-4 h-4" /></button></div>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4 relative" style={{ backgroundImage: `radial-gradient(${isDarkMode ? '#334155' : '#cbd5e1'} 1px, transparent 1px)`, backgroundSize: '20px 20px' }}>
                            <div className="max-w-4xl mx-auto pb-24">
                                {view === 'dashboard' && (<><DashboardView transactions={currentYearData} isDark={isDarkMode} /><div className="fixed bottom-20 right-4 z-30 flex flex-col-reverse gap-3 items-end md:bottom-8 pointer-events-none w-full px-4 md:px-0 md:w-auto"><FinancialHealthWidget transactions={currentYearData} isVisible={widgets.health} onClose={() => toggleWidget('health')} currentYear={selectedYear} isDark={isDarkMode} /><BudgetAlertWidget transactions={currentYearData} budgets={budgets} isVisible={widgets.budgetAlert} onClose={() => toggleWidget('budgetAlert')} currentYear={selectedYear} isDark={isDarkMode} /><TopExpensesWidget transactions={currentYearData} isVisible={widgets.topExpenses} onClose={() => toggleWidget('topExpenses')} currentYear={selectedYear} isDark={isDarkMode} /><SavingsWidget transactions={currentYearData} isVisible={widgets.savings} onClose={() => toggleWidget('savings')} currentYear={selectedYear} isDark={isDarkMode} /></div></>)}
                                {view === 'calendar' && <CalendarView transactions={currentYearData} selectedYear={selectedYear} onDateClick={(d) => openForm(null, d)} isDark={isDarkMode} />}
                                {view === 'history' && <HistoryView transactions={currentYearData} onEdit={openForm} onDelete={deleteTransaction} isDark={isDarkMode} />}
                                {view === 'members' && <MembersView family={family} familyMembers={familyMembers} isDark={isDarkMode} />}
                                {view === 'budgets' && <BudgetsView transactions={currentYearData} currentYear={selectedYear} family={family} isDark={isDarkMode} />}
                            </div>
                        </main>

                        <button onClick={() => openForm()} className={`fixed bottom-20 right-4 md:bottom-8 md:right-8 w-12 h-12 md:w-14 md:h-14 ${THEME.primary} hover:bg-[#006e5a] text-white rounded-2xl shadow-lg flex items-center justify-center transition-transform hover:scale-105 active:scale-95 z-40`}><Plus className="w-6 h-6 md:w-7 md:h-7" /></button>

                        <div className={`md:hidden ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} border-t h-16 flex justify-around items-center px-2 z-50 fixed bottom-0 left-0 right-0`}>
                            <button onClick={() => setView('dashboard')} className={`flex flex-col items-center gap-1 p-2 rounded-lg transition ${view === 'dashboard' ? 'text-[#008069]' : 'text-slate-400'}`}><PieChart className="w-5 h-5" /><span className="text-[10px] font-medium">Estado</span></button>
                            <button onClick={() => setView('calendar')} className={`flex flex-col items-center gap-1 p-2 rounded-lg transition ${view === 'calendar' ? 'text-[#008069]' : 'text-slate-400'}`}><CalendarIcon className="w-5 h-5" /><span className="text-[10px] font-medium">Cal.</span></button>
                            <button onClick={() => setView('history')} className={`flex flex-col items-center gap-1 p-2 rounded-lg transition ${view === 'history' ? 'text-[#008069]' : 'text-slate-400'}`}><Layers className="w-5 h-5" /><span className="text-[10px] font-medium">Hist.</span></button>
                        </div>
                    </div>

                    {isFormOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
                            <div className={`w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up ${isDarkMode ? 'bg-slate-800' : 'bg-white'}`}>
                                <div className={`${THEME.primary} p-4 flex justify-between items-center text-white`}><h3 className="font-bold">{editingId ? 'Editar' : 'Nuevo'}</h3><button onClick={closeForm}><X className="w-5 h-5" /></button></div>
                                <form onSubmit={handleSubmit} className="p-6 space-y-6">
                                    <div className={`flex p-1 rounded-xl ${isDarkMode ? 'bg-slate-700' : 'bg-slate-100'}`}>
                                        <button type="button" onClick={() => setFormData({...formData, type: 'income', category: 'Salario'})} className={`flex-1 py-2 text-sm font-bold rounded-lg transition ${formData.type === 'income' ? 'bg-white text-[#008069] shadow-sm' : 'text-slate-400'}`}>Ingreso</button>
                                        <button type="button" onClick={() => setFormData({...formData, type: 'expense', category: 'Comida'})} className={`flex-1 py-2 text-sm font-bold rounded-lg transition ${formData.type === 'expense' ? 'bg-white text-red-500 shadow-sm' : 'text-slate-400'}`}>Gasto</button>
                                    </div>
                                    <div className="relative"><span className={`absolute left-3 top-1/2 -translate-y-1/2 text-2xl font-light ${formData.type === 'income' ? 'text-[#008069]' : 'text-red-500'}`}>$</span><input type="number" step="0.01" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} className={`w-full text-center text-4xl font-bold bg-transparent border-b-2 outline-none pb-2 ${isDarkMode ? 'text-white border-slate-600' : 'text-slate-800 border-slate-100'}`} placeholder="0.00" autoFocus /></div>
                                    <div className={`text-center text-xs ${isDark ? 'text-slate-400' : 'text-slate-500'}`}>Registrando como: <span className="font-bold text-[#008069]">{memberProfile.name}</span></div>
                                    {familyMembers.filter(m => m.uid !== user.uid).length > 0 && (
                                         <div className={`${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-200'} p-2 rounded-lg border`}><label className="text-[10px] uppercase font-bold text-slate-400 block mb-1">¿O es para alguien más?</label><select value={formData.memberId || ''} onChange={e => setFormData({...formData, memberId: e.target.value})} className={`w-full bg-transparent text-sm font-semibold outline-none ${isDarkMode ? 'text-slate-200' : 'text-slate-700'}`}><option value="" className={isDarkMode ? 'text-black' : ''}>{memberProfile.name} (Yo)</option>{familyMembers.filter(m => m.uid !== user.uid).map(m => (<option key={m.id} value={m.id} className={isDarkMode ? 'text-black' : ''}>{m.name}</option>))}</select></div>
                                    )}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className={`${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-200'} p-2 rounded-lg border`}><label className="text-[10px] uppercase font-bold text-slate-400 block mb-1">Categoría</label><select value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})} className={`w-full bg-transparent text-sm font-semibold outline-none ${isDarkMode ? 'text-slate-200' : 'text-slate-700'}`}>{formData.type === 'expense' ? (<><option>Comida</option><option>Transporte</option><option>Vivienda</option><option>Escuela</option><option>Despensa</option><option>Tienda</option><option>Comida a domicilio</option><option>Servicios</option><option>Deuda</option><option>Préstamos</option><option>Tarjetas de Crédito</option><option>Deuda Familiar</option><option>Gastos Hormiga</option><option>Otros</option></>) : (<><option>Salario</option><option>Negocio</option><option>Ventas</option><option>Extra</option><option>Otros</option></>)}</select></div>
                                        <div className={`${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-200'} p-2 rounded-lg border`}><label className="text-[10px] uppercase font-bold text-slate-400 block mb-1">Fecha</label><input type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className={`w-full bg-transparent text-sm font-semibold outline-none ${isDarkMode ? 'text-slate-200' : 'text-slate-700'}`} /></div>
                                    </div>
                                    <button type="submit" className={`w-full py-3 rounded-xl font-bold text-white shadow-md active:scale-95 transition ${formData.type === 'income' ? THEME.primary : 'bg-red-500'}`}>{editingId ? 'Actualizar' : 'Enviar'}</button>
                                </form>
                            </div>
                        </div>
                    )}
                    {deleteModal.show && <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm"><div className={`${isDarkMode ? 'bg-slate-800' : 'bg-white'} p-6 rounded-2xl shadow-xl max-w-xs w-full text-center space-y-4`}><div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto text-red-500"><Trash2 /></div><h3 className={`font-bold ${isDarkMode ? 'text-slate-200' : 'text-slate-800'}`}>¿Eliminar mensaje?</h3><div className="flex gap-2"><button onClick={() => setDeleteModal({show:false, id:null})} className={`flex-1 py-2 border rounded-xl ${isDarkMode ? 'text-slate-300 border-slate-600' : 'text-slate-600'}`}>Cancelar</button><button onClick={deleteItem} className="flex-1 py-2 bg-red-500 text-white rounded-xl">Eliminar</button></div></div></div>}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
